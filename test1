import { React } from "jimu-core";
import { JimuMapViewComponent, JimuMapView } from "jimu-arcgis";
import VectorTileLayer from "@arcgis/core/layers/VectorTileLayer";

// API Configuration
const MVT_STYLE_URL = "https://your-api.com/api/vector/styles/all/style.json?coverageLayer=rsrp_dbm_poly";
const MANUAL_BEARER = "your_bearer_token_here";

interface State {
  jimuMapView: JimuMapView;
}

export default class Widget extends React.PureComponent<any, State> {
  private mvtLayer: VectorTileLayer = null;

  constructor(props) {
    super(props);
    this.state = {
      jimuMapView: null
    };
  }

  onActiveViewChange = (jmv: JimuMapView) => {
    if (jmv) {
      this.setState({ jimuMapView: jmv });
      this.loadMVTLayer(jmv);
    }
  };

  loadMVTLayer = async (jmv: JimuMapView) => {
    if (this.mvtLayer) {
      jmv.view.map.remove(this.mvtLayer);
    }

    try {
      // Fetch style.json with Bearer token
      const response = await fetch(MVT_STYLE_URL, {
        headers: {
          'Authorization': `Bearer ${MANUAL_BEARER}`
        }
      });

      const styleJson = await response.json();

      // Create VectorTileLayer from style
      this.mvtLayer = VectorTileLayer.fromArcGISStyle(styleJson);

      // Intercept tile requests to add auth
      const loadFunc = this.mvtLayer.load.bind(this.mvtLayer);
      this.mvtLayer.load = async () => {
        await loadFunc();
        this.interceptTileRequests();
        return this.mvtLayer;
      };

      jmv.view.map.add(this.mvtLayer);
      
    } catch (error) {
      console.error("MVT Layer yÃ¼klenemedi:", error);
    }
  };

  interceptTileRequests = () => {
    const originalFetch = window.fetch;
    window.fetch = (url, options = {}) => {
      // Check if this is a tile request from our API
      if (url.toString().includes(new URL(MVT_STYLE_URL).hostname)) {
        const newOptions = {
          ...options,
          headers: {
            ...options.headers,
            'Authorization': `Bearer ${MANUAL_BEARER}`
          }
        };
        return originalFetch(url, newOptions);
      }
      return originalFetch(url, options);
    };
  };

  componentWillUnmount() {
    if (this.mvtLayer && this.state.jimuMapView) {
      this.state.jimuMapView.view.map.remove(this.mvtLayer);
    }
  }

  render() {
    return (
      <div className="widget-mvt" style={{ width: "100%", height: "100%" }}>
        <JimuMapViewComponent
          useMapWidgetId={this.props.useMapWidgetIds?.[0]}
          onActiveViewChange={this.onActiveViewChange}
        />
      </div>
    );
  }
}
