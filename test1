/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "url//api/vector/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;
  private originalFetch = window.fetch;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget y√ºkleniyor...",
      currentZoom: 7
    };
  }

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  loadArcGISAPI = () => {
    this.setState({ message: "üì¶ ArcGIS API y√ºkleniyor..." });

    if ((window as any).require) {
      this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
      this.createMap();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const existing = document.querySelector(`script[data-arcgis-api="${ARCGIS_API_VERSION}"]`) as HTMLScriptElement | null;
    if (existing) {
      existing.addEventListener('load', () => {
        this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
        this.createMap();
      });
      return;
    }

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.setAttribute('data-arcgis-api', ARCGIS_API_VERSION);
    script.onload = () => {
      this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
      this.createMap();
    };
    script.onerror = () => {
      this.setState({ message: "‚ùå ArcGIS API y√ºklenemedi" });
    };
    document.head.appendChild(script);
  };

  createMap = () => {
    this.setState({ message: "üó∫Ô∏è Map olu≈üturuluyor..." });

    if (!this.mapDiv) {
      setTimeout(() => this.createMap(), 50);
      return;
    }

    if (!(window as any).require) {
      this.setState({ message: "‚ùå ArcGIS API loader bulunamadƒ±" });
      return;
    }

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer',
      'esri/request'
    ], (Map, MapView, VectorTileLayer, esriRequest) => {
      
      const map = new Map({
        basemap: 'dark-gray-vector'  // Veya 'gray-vector', 'streets-night-vector'
      });

      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39],
        zoom: 15,
        constraints: {
          snapToZoom: false,
          minZoom: 3,
          maxzoom: 22
        }
      });

      this.mapView.watch('zoom', (newZoom) => {
        this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
      });

      this.setState({ message: "‚úÖ Map olu≈üturuldu! MVT y√ºkleniyor..." });

      // esriRequest ile Authorization header ekle
      esriRequest(MVT_STYLE_URL, {
        headers: {
          'Authorization': `Bearer ${MANUAL_BEARER}`
        },
        responseType: 'json'
      }).then(response => {
        this.setState({ message: "üìÑ Style JSON alƒ±ndƒ±" });
        let styleJson = response.data;

        // ZOOM RANGE AYARLA + OVERZOOM FIX
        Object.keys(styleJson.sources).forEach(key => {
          const source = styleJson.sources[key];
          if (key === 'coverage_15z') {
            source.minzoom = 15;
            source.maxzoom = 15;  // ‚úÖ API sadece 15'te tile √ºretiyor
          } else if (key === 'coverage_11z') {
            source.minzoom = 11;
            source.maxzoom = 11;
          } else if (key === 'coverage_7z') {
            source.minzoom = 7;
            source.maxzoom = 7;
          } else if (key === 'coverage_3z') {
            source.minzoom = 3;
            source.maxzoom = 3;
          }
        });

        // ‚úÖ‚úÖ‚úÖ KRƒ∞Tƒ∞K: Layer zoom range'lerini OVERLAP OLMADAN ayarla
        styleJson.layers = styleJson.layers.map(layer => {
          const newLayer = {...layer};
          
          if (layer.id.includes('15z')) {
            newLayer.minzoom = 15;  // ‚úÖ TAM 15'te ba≈üla
            newLayer.maxzoom = 22;
          } else if (layer.id.includes('11z')) {
            newLayer.minzoom = 11;
            newLayer.maxzoom = 14.99;  // ‚úÖ 15'TEN √ñNCE Bƒ∞T (overlap yok)
          } else if (layer.id.includes('7z')) {
            newLayer.minzoom = 7;
            newLayer.maxzoom = 10.99;  // ‚úÖ 11'DEN √ñNCE Bƒ∞T
          } else if (layer.id.includes('3z')) {
            newLayer.minzoom = 3;
            newLayer.maxzoom = 6.99;   // ‚úÖ 7'DEN √ñNCE Bƒ∞T
          }
          
          return newLayer;
        });

        console.log("Style JSON (zoom adjusted):", styleJson);
        console.log("Layer zoom ranges:");
        styleJson.layers.forEach(layer => {
          console.log(`  ${layer.id}: ${layer.minzoom} - ${layer.maxzoom}`);
        });

        // VectorTileLayer olu≈ütur - OVERZOOM ayarlarƒ±yla
        const mvtLayer = new VectorTileLayer({
          style: styleJson,
          minScale: 0,
          maxScale: 0
        });

        // Layer load event'inde tile URL'lerini intercept et
        mvtLayer.when(() => {
          this.setState({ message: "‚úÖ MVT Layer y√ºklendi!" });
          
          // Override fetch for tile requests
          const originalFetch = window.fetch;
          window.fetch = (url, options = {}) => {
            const urlStr = url.toString();
            if (urlStr.includes(new URL(MVT_STYLE_URL).hostname)) {
              
              // ‚úÖ‚úÖ‚úÖ OVERZOOM FIX: Zoom 16+ i√ßin zoom 15 tile'ƒ±nƒ± kullan
              let modifiedUrl = urlStr;
              const zxyMatch = urlStr.match(/\/(\d+)\/(\d+)\/(\d+)\.pbf/);
              if (zxyMatch) {
                const [, z, x, y] = zxyMatch;
                const zoom = parseInt(z);
                
                if (zoom > 15) {
                  // Zoom 16+ ‚Üí zoom 15 tile'ƒ±nƒ± kullan (overzoom)
                  // x, y koordinatlarƒ±nƒ± zoom 15'e √ßevir
                  const scale = Math.pow(2, zoom - 15);
                  const x15 = Math.floor(parseInt(x) / scale);
                  const y15 = Math.floor(parseInt(y) / scale);
                  modifiedUrl = urlStr.replace(/\/\d+\/\d+\/\d+\.pbf/, `/15/${x15}/${y15}.pbf`);
                  console.log(`üîÑ Overzoom: ${z}/${x}/${y} ‚Üí 15/${x15}/${y15}`);
                }
              }
              
              return originalFetch(modifiedUrl, {
                ...options,
                headers: {
                  ...(options['headers'] || {}),
                  'Authorization': `Bearer ${MANUAL_BEARER}`
                }
              });
            }
            return originalFetch(url, options);
          };
        }).catch(err => {
          this.setState({ message: `‚ùå Layer error: ${err.message}` });
          console.error("Layer hatasƒ±:", err);
        });

        map.add(mvtLayer);
        
      }).catch(err => {
        this.setState({ message: `‚ùå Fetch error: ${err.message}` });
        console.error("FETCH HATASI:", err);
      });
    }, (err) => {
      this.setState({ message: `‚ùå Loader error: ${err?.message || err}` });
      console.error('AMD require error:', err);
    });
  };

  render() {
    const { message, currentZoom } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.8)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px"
        }}>
          <strong>MVT Widget:</strong>
          <div style={{ marginTop: "10px" }}>{message}</div>
          <div style={{ marginTop: "5px", fontSize: "11px" }}>
            Zoom: {currentZoom} | Bins: {
              currentZoom < 6 ? "10km" :
              currentZoom < 10 ? "1km" :
              currentZoom < 14 ? "100m" : "10m"
            }
          </div>
        </div>
      </div>
    );
  }
}
