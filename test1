/** @jsx jsx */
import { React, jsx, AllWidgetProps } from 'jimu-core';
import { JimuMapView, JimuMapViewComponent } from 'jimu-arcgis';

/**
 * Professional dual-thumb slider with interactive color scale
 */
type DualRangeSliderProps = {
  min: number;
  max: number;
  step?: number;
  minValue: number;
  maxValue: number;
  onChange: (newMin: number, newMax: number) => void;
  field: string;
  legendSegments: LegendSegment[];
};

const DualRangeSlider: React.FC<DualRangeSliderProps> = ({
  min,
  max,
  step = 1,
  minValue,
  maxValue,
  onChange,
  field,
  legendSegments
}) => {
  const trackRef = React.useRef<HTMLDivElement>(null);
  const activeRef = React.useRef<null | { thumb: 'min' | 'max'; pointerId: number }>(null);
  const [hoveredSegment, setHoveredSegment] = React.useState<number | null>(null);

  const clamp = (v: number, a: number, b: number) => Math.max(a, Math.min(b, v));
  const valueToPercent = (v: number) => ((v - min) * 100) / (max - min);
  const snap = (v: number) => Math.round(v / step) * step;

  const handlePointerDown = (thumb: 'min' | 'max') => (e: React.PointerEvent) => {
    e.preventDefault();
    e.stopPropagation();
    activeRef.current = { thumb, pointerId: e.pointerId };
    try {
      (e.currentTarget as HTMLElement).setPointerCapture?.(e.pointerId);
    } catch {}
  };

  const handlePointerMove = (thumb: 'min' | 'max') => (e: React.PointerEvent) => {
    const active = activeRef.current;
    if (!active || active.thumb !== thumb || active.pointerId !== e.pointerId || !trackRef.current) {
      return;
    }

    const rect = trackRef.current.getBoundingClientRect();
    const ratio = clamp((e.clientX - rect.left) / rect.width, 0, 1);
    let val = snap(min + ratio * (max - min));
    val = clamp(val, min, max);

    if (thumb === 'min') {
      const newMin = Math.min(val, maxValue);
      if (newMin !== minValue) {
        onChange(newMin, maxValue);
      }
    } else {
      const newMax = Math.max(val, minValue);
      if (newMax !== maxValue) {
        onChange(minValue, newMax);
      }
    }
  };

  const handlePointerUp = (thumb: 'min' | 'max') => (e: React.PointerEvent) => {
    const active = activeRef.current;
    if (active && active.thumb === thumb && active.pointerId === e.pointerId) {
      activeRef.current = null;
      try {
        (e.currentTarget as HTMLElement).releasePointerCapture?.(e.pointerId);
      } catch {}
    }
  };

  const minPercent = valueToPercent(minValue);
  const maxPercent = valueToPercent(maxValue);

  const total = max - min;
  const toPercent = (start: number, end: number) => {
    const clampedStart = Math.max(start, min);
    const clampedEnd = Math.min(end, max);
    const span = clampedEnd - clampedStart;
    return Math.max((span / total) * 100, 0);
  };

  const getSegmentOpacity = (segmentIndex: number, segmentFrom: number, segmentTo: number): number => {
    const segStart = segmentFrom ?? min;
    const segEnd = segmentTo ?? max;
    
    // Check if segment is within selected range
    const isInRange = !(segEnd < minValue || segStart > maxValue);
    
    if (hoveredSegment === segmentIndex) {
      return 1;
    }
    
    return isInRange ? 0.95 : 0.3;
  };

  return (
    <div style={{ width: '100%', padding: '12px 0', touchAction: 'none' }}>
      {/* Value Display */}
      <div style={{ 
        display: 'flex', 
        justifyContent: 'space-between', 
        marginBottom: 16,
        padding: '0 4px'
      }}>
        <div style={{ 
          display: 'flex', 
          flexDirection: 'column',
          alignItems: 'flex-start'
        }}>
          <span style={{ fontSize: 11, color: '#6c757d', fontWeight: 500, marginBottom: 2 }}>MIN</span>
          <span style={{ 
            fontSize: 20, 
            fontWeight: 700, 
            color: '#0079c1',
            fontVariantNumeric: 'tabular-nums'
          }}>{minValue}</span>
        </div>
        <div style={{ 
          display: 'flex', 
          flexDirection: 'column',
          alignItems: 'flex-end'
        }}>
          <span style={{ fontSize: 11, color: '#6c757d', fontWeight: 500, marginBottom: 2 }}>MAX</span>
          <span style={{ 
            fontSize: 20, 
            fontWeight: 700, 
            color: '#0079c1',
            fontVariantNumeric: 'tabular-nums'
          }}>{maxValue}</span>
        </div>
      </div>

      {/* Interactive Color Scale */}
      <div style={{ marginBottom: 20 }}>
        <div
          style={{
            display: 'flex',
            height: 24,
            borderRadius: 6,
            overflow: 'hidden',
            boxShadow: '0 2px 8px rgba(0,0,0,0.12)',
            border: '1px solid rgba(0,0,0,0.08)',
            transition: 'all 0.2s ease'
          }}
        >
          {legendSegments.map((segment, idx) => {
            const widthPercent = toPercent(segment.from ?? min, segment.to ?? max);
            if (widthPercent <= 0) return null;

            const opacity = getSegmentOpacity(idx, segment.from ?? min, segment.to ?? max);

            return (
              <div
                key={`${field}-band-${idx}`}
                onMouseEnter={() => setHoveredSegment(idx)}
                onMouseLeave={() => setHoveredSegment(null)}
                style={{
                  width: `${widthPercent}%`,
                  backgroundColor: segment.color,
                  opacity,
                  transition: 'opacity 0.2s ease',
                  cursor: 'pointer',
                  position: 'relative'
                }}
                title={segment.label}
              />
            );
          })}
        </div>
        
        {/* Tooltip on hover */}
        {hoveredSegment !== null && legendSegments[hoveredSegment] && (
          <div style={{
            marginTop: 8,
            padding: '6px 12px',
            backgroundColor: '#2c3e50',
            color: '#fff',
            borderRadius: 4,
            fontSize: 12,
            fontWeight: 500,
            textAlign: 'center',
            animation: 'fadeIn 0.2s ease'
          }}>
            {legendSegments[hoveredSegment].label}
          </div>
        )}
      </div>

      {/* Slider Track */}
      <div ref={trackRef} style={{ position: 'relative', height: 40, userSelect: 'none', padding: '0 4px' }}>
        {/* Background Track */}
        <div
          style={{
            position: 'absolute',
            top: 18,
            left: 4,
            right: 4,
            height: 6,
            background: 'linear-gradient(to right, #e9ecef, #dee2e6)',
            borderRadius: 3,
            boxShadow: 'inset 0 1px 2px rgba(0,0,0,0.1)'
          }}
        />
        
        {/* Selected range highlight */}
        <div
          style={{
            position: 'absolute',
            top: 18,
            left: `calc(${minPercent}% + 4px)`,
            width: `calc(${Math.max(0, maxPercent - minPercent)}% - 4px)`,
            height: 6,
            background: 'linear-gradient(135deg, #0079c1 0%, #00a8e8 100%)',
            borderRadius: 3,
            boxShadow: '0 2px 4px rgba(0,121,193,0.3)',
            transition: 'all 0.1s ease'
          }}
        />
        
        {/* Min thumb */}
        <div
          onPointerDown={handlePointerDown('min')}
          onPointerMove={handlePointerMove('min')}
          onPointerUp={handlePointerUp('min')}
          onPointerCancel={handlePointerUp('min')}
          style={{
            position: 'absolute',
            top: 10,
            left: `calc(${minPercent}% - 6px)`,
            width: 20,
            height: 20,
            background: 'linear-gradient(135deg, #fff 0%, #f8f9fa 100%)',
            border: '3px solid #0079c1',
            borderRadius: '50%',
            cursor: 'grab',
            boxShadow: '0 3px 8px rgba(0,0,0,0.2)',
            zIndex: 3,
            transition: 'transform 0.1s ease',
            transform: activeRef.current?.thumb === 'min' ? 'scale(1.2)' : 'scale(1)'
          }}
          title="Min"
        />
        
        {/* Max thumb */}
        <div
          onPointerDown={handlePointerDown('max')}
          onPointerMove={handlePointerMove('max')}
          onPointerUp={handlePointerUp('max')}
          onPointerCancel={handlePointerUp('max')}
          style={{
            position: 'absolute',
            top: 10,
            left: `calc(${maxPercent}% - 6px)`,
            width: 20,
            height: 20,
            background: 'linear-gradient(135deg, #fff 0%, #f8f9fa 100%)',
            border: '3px solid #0079c1',
            borderRadius: '50%',
            cursor: 'grab',
            boxShadow: '0 3px 8px rgba(0,0,0,0.2)',
            zIndex: 3,
            transition: 'transform 0.1s ease',
            transform: activeRef.current?.thumb === 'max' ? 'scale(1.2)' : 'scale(1)'
          }}
          title="Max"
        />
      </div>
    </div>
  );
};

interface FilterCondition {
  id: string;
  field: string;
  min: number;
  max: number;
}

interface State {
  conditions: FilterCondition[];
  selectedField: string;
  tempMin: number;
  tempMax: number;
  activeWhere: string | null;
  usidInput: string;
  activeUsid: string[] | null;
  usidError: string | null;
}

const FIELD_RANGES: Record<string, { min: number; max: number; def: [number, number] }> = {
  RSRP: { min: -140, max: -50, def: [-140, -50] },
  RSRQ: { min: -25, max: 0, def: [-25, 0] },
  SNR: { min: -20, max: 35, def: [-20, 35] }
};

interface LegendSegment {
  from?: number;
  to?: number;
  color: string;
  label: string;
}

const KPI_LEGENDS: Record<string, LegendSegment[]> = {
  RSRP: [
    { from: FIELD_RANGES.RSRP.min, to: -118, color: '#ff00ff', label: '< -118 dBm' },
    { from: -118, to: -115, color: '#ff0000', label: '-118 to -115 dBm' },
    { from: -115, to: -110, color: '#ff8c00', label: '-115 to -110 dBm' },
    { from: -110, to: -105, color: '#ffd700', label: '-110 to -105 dBm' },
    { from: -105, to: -95, color: '#40e0d0', label: '-105 to -95 dBm' },
    { from: -95, to: -85, color: '#0000ff', label: '-95 to -85 dBm' },
    { from: -85, to: FIELD_RANGES.RSRP.max, color: '#008000', label: '≥ -85 dBm' }
  ],
  RSRQ: [
    { from: FIELD_RANGES.RSRQ.min, to: -16, color: '#ff0000', label: '< -16 dB' },
    { from: -16, to: -10, color: '#ffd700', label: '-16 to -10 dB' },
    { from: -10, to: -5, color: '#0000ff', label: '-10 to -5 dB' },
    { from: -5, to: FIELD_RANGES.RSRQ.max, color: '#008000', label: '≥ -5 dB' }
  ],
  SNR: [
    { from: FIELD_RANGES.SNR.min, to: -10, color: '#ff0000', label: '< -10 dB' },
    { from: -10, to: -5, color: '#ff8c00', label: '-10 to -5 dB' },
    { from: -5, to: 0, color: '#ffd700', label: '-5 to 0 dB' },
    { from: 0, to: 5, color: '#40e0d0', label: '0 to 5 dB' },
    { from: 5, to: 10, color: '#0000ff', label: '5 to 10 dB' },
    { from: 10, to: FIELD_RANGES.SNR.max, color: '#008000', label: '≥ 10 dB' }
  ]
};

export default class Widget extends React.PureComponent<AllWidgetProps<any>, State> {
  state: State;
  private mapView: JimuMapView = null;
  private viewHandles: any[] = [];
  private layerHandles: any[] = [];
  private sublayerHandles: any[] = [];

  constructor(props: AllWidgetProps<any>) {
    super(props);
    this.state = {
      conditions: [],
      selectedField: 'RSRP',
      tempMin: FIELD_RANGES.RSRP.def[0],
      tempMax: FIELD_RANGES.RSRP.def[1],
      activeWhere: null,
      usidInput: '',
      activeUsid: null,
      usidError: null
    };
  }

  componentWillUnmount(): void {
    this.removeAllHandles();
  }

  removeAllHandles = () => {
    const remove = (h: any) => { try { h?.remove?.(); } catch {} };
    this.viewHandles.forEach(remove);
    this.layerHandles.forEach(remove);
    this.sublayerHandles.forEach(remove);
    this.viewHandles = [];
    this.layerHandles = [];
    this.sublayerHandles = [];
  };

  onActiveViewChange = (jimuMapView: JimuMapView) => {
    if (!jimuMapView) return;
    this.mapView = jimuMapView;
    this.removeAllHandles();

    const v: any = this.mapView.view;
    if (!v) return;

    const hCreate = v.on('layerview-create', () => {
      if (this.state.activeWhere) this.applyActiveWhereToAll();
    });

    const hDestroy = v.on('layerview-destroy', () => {
      if (this.state.activeWhere) this.applyActiveWhereToAll();
    });

    const hStationary = v.watch('stationary', (st: boolean) => {
      if (st && this.state.activeWhere) this.applyActiveWhereToAll();
    });

    const hLayersChange = v.map?.allLayers?.on?.('change', () => {
      if (this.state.activeWhere) this.applyActiveWhereToAll();
    });

    const popupHandles: any[] = [];
    const popup = v.popup;
    if (popup?.watch) {
      const hPopupVisible = popup.watch('visible', () => {
        if (this.state.activeWhere) {
          setTimeout(() => this.applyActiveWhereToAll(), 0);
        }
      });
      if (hPopupVisible) popupHandles.push(hPopupVisible);

      const hPopupSelected = popup.watch('selectedFeature', () => {
        if (this.state.activeWhere) {
          setTimeout(() => this.applyActiveWhereToAll(), 0);
        }
      });
      if (hPopupSelected) popupHandles.push(hPopupSelected);
    }

    this.viewHandles.push(hCreate, hDestroy, hStationary, hLayersChange, ...popupHandles);
  };

  onFieldChange = (e: any) => {
    const field = e.target.value;
    const r = FIELD_RANGES[field];
    this.setState({
      selectedField: field,
      tempMin: r.def[0],
      tempMax: r.def[1]
    });
  };

  onSliderChange = (newMin: number, newMax: number) => {
    this.setState({ tempMin: newMin, tempMax: newMax });
  };

  addCondition = () => {
    const { selectedField, tempMin, tempMax, conditions } = this.state;
    const i = conditions.findIndex((c: FilterCondition) => c.field === selectedField);

    let next: FilterCondition[];
    if (i >= 0) {
      next = [...conditions];
      next[i] = { ...next[i], min: tempMin, max: tempMax };
    } else {
      next = [...conditions, { id: Date.now().toString(), field: selectedField, min: tempMin, max: tempMax }];
    }

    this.setState({ conditions: next }, () => this.applyFromConditions());
  };

  removeCondition = (id: string) => {
    const next = this.state.conditions.filter((c: FilterCondition) => c.id !== id);
    this.setState({ conditions: next }, () => this.applyFromConditions());
  };

  buildWhere = (conds: FilterCondition[], usids?: string[] | null) => {
    const parts: string[] = [];

    if (conds?.length) {
      conds.forEach((c: FilterCondition) => {
        parts.push(`${c.field} >= ${c.min} AND ${c.field} <= ${c.max}`);
      });
    }

    if (Array.isArray(usids) && usids.length) {
      const clauses = usids
        .map((value: string) => {
          const trimmed = value.trim();
          if (!trimmed) return null;
          const isNumeric = /^-?\d+(?:\.\d+)?$/.test(trimmed);
          const sanitized = trimmed.replace(/'/g, "''");
          return isNumeric ? `USID = ${sanitized}` : `USID = '${sanitized}'`;
        })
        .filter(Boolean) as string[];

      if (clauses.length === 1) {
        parts.push(clauses[0]);
      } else if (clauses.length > 1) {
        parts.push(`(${clauses.join(' OR ')})`);
      }
    }

    return parts.length ? parts.join(' AND ') : null;
  };

  applyFromConditions = () => {
    const { conditions, activeUsid } = this.state;
    const where = this.buildWhere(conditions, activeUsid);

    if (!where) {
      this.setState({ activeWhere: null }, () => this.clearLayerDefinitions());
      return;
    }

    this.setState({ activeWhere: where }, () => this.applyActiveWhereToAll());
  };

  onUsidInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    this.setState({ usidInput: e.target.value, usidError: null });
  };

  onUsidKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      this.applyUsidFilter();
    }
  };

  applyUsidFilter = () => {
    const raw = (this.state.usidInput || '').trim();

    if (!raw) {
      this.setState({ activeUsid: null, usidError: null }, () => this.applyFromConditions());
      return;
    }

    const entries = raw
      .split(',')
      .map(item => item.trim())
      .filter(Boolean);

    if (!entries.length) {
      this.setState({ activeUsid: null, usidError: null }, () => this.applyFromConditions());
      return;
    }

    this.setState({ activeUsid: entries, usidError: null }, () => this.applyFromConditions());
  };

  clearUsid = () => {
    this.setState({ usidInput: '', activeUsid: null, usidError: null }, () => this.applyFromConditions());
  };

  clearLayerDefinitions = () => {
    if (!this.mapView) return;

    const view: any = this.mapView.view;
    const layers = view?.map?.allLayers;
    if (!layers) return;

    layers.forEach((layer: any) => {
      if (!layer) return;

      if (layer.type === 'feature') {
        try {
          if (typeof layer.definitionExpression !== 'undefined') {
            layer.definitionExpression = null;
          }
        } catch {}

        try {
          view.whenLayerView(layer).then((lv: any) => {
            try { if (lv) lv.filter = null; } catch {}
          }).catch(() => {});
        } catch {}
      }

      if (layer.type === 'map-image' && layer.allSublayers) {
        layer.allSublayers.forEach((sublayer: any) => {
          try {
            if (typeof sublayer.definitionExpression !== 'undefined') {
              sublayer.definitionExpression = null;
            }
          } catch {}
        });

        try { layer.refresh && layer.refresh(); } catch {}
      }
    });
  };

  isTargetFeatureLayer = (layer: any): boolean => {
    const fields = layer?.fields || [];
    return fields.some((f: any) => {
      const n = (f?.name || '').toUpperCase();
      return n.includes('RSRP') || n.includes('RSRQ') || n.includes('SNR');
    });
  };

  isTargetSublayer = (sublayer: any): boolean => {
    const title = (sublayer?.title || '').toUpperCase();
    return title.includes('RSRP') || title.includes('RSRQ') || title.includes('SNR');
  };

  applyActiveWhereToAll = () => {
    const where = this.state.activeWhere;
    if (!this.mapView || !where) return;
    const view: any = this.mapView.view;
    const layers = view?.map?.allLayers;
    if (!layers) return;

    this.layerHandles.forEach(h => { try { h?.remove?.(); } catch {} });
    this.layerHandles = [];
    this.sublayerHandles.forEach(h => { try { h?.remove?.(); } catch {} });
    this.sublayerHandles = [];

    const activeWhereSnapshot = where;

    layers.forEach((layer: any) => {
      if (!layer) return;

      if (layer.type === 'feature') {
        if (this.isTargetFeatureLayer(layer)) {
          try { layer.definitionExpression = where; } catch {}
          if (typeof layer.watch === 'function') {
            const hLayerDef = layer.watch('definitionExpression', (value: string) => {
              if (this.state.activeWhere !== activeWhereSnapshot) return;
              if (value !== activeWhereSnapshot) {
                try { layer.definitionExpression = activeWhereSnapshot; } catch {}
              }
            });
            if (hLayerDef) this.layerHandles.push(hLayerDef);
          }
          try {
            view.whenLayerView(layer).then((lv: any) => {
              try { lv.filter = { where: activeWhereSnapshot }; } catch {}
              if (typeof lv?.watch === 'function') {
                const hLayerFilter = lv.watch('filter', (filterValue: any) => {
                  if (this.state.activeWhere !== activeWhereSnapshot) return;
                  const currentWhere = filterValue?.where;
                  if (!currentWhere || currentWhere !== activeWhereSnapshot) {
                    try { lv.filter = { where: activeWhereSnapshot }; } catch {}
                  }
                });
                if (hLayerFilter) this.layerHandles.push(hLayerFilter);
              }
            }).catch(() => {});
          } catch {}
        }
      }

      if (layer.type === 'map-image' && layer.allSublayers) {
        layer.allSublayers.forEach((sublayer: any) => {
          if (!this.isTargetSublayer(sublayer)) return;
          try {
            if (typeof sublayer.definitionExpression !== 'undefined') {
              sublayer.definitionExpression = where;
            }
          } catch {}

          if (typeof sublayer.watch === 'function') {
            const hSubDef = sublayer.watch('definitionExpression', (value: string) => {
              if (this.state.activeWhere !== activeWhereSnapshot) return;
              if (value !== activeWhereSnapshot) {
                try {
                  if (typeof sublayer.definitionExpression !== 'undefined') {
                    sublayer.definitionExpression = activeWhereSnapshot;
                  }
                } catch {}
              }
            });
            if (hSubDef) this.sublayerHandles.push(hSubDef);
          }

          const hVis = sublayer.watch && sublayer.watch('visible', () => {
            if (this.state.activeWhere !== activeWhereSnapshot) return;
            try {
              if (typeof sublayer.definitionExpression !== 'undefined') {
                sublayer.definitionExpression = activeWhereSnapshot;
              }
            } catch {}
          });
          const hMinScale = sublayer.watch && sublayer.watch('minScale', () => {
            if (this.state.activeWhere !== activeWhereSnapshot) return;
            try {
              if (typeof sublayer.definitionExpression !== 'undefined') {
                sublayer.definitionExpression = activeWhereSnapshot;
              }
            } catch {}
          });
          const hMaxScale = sublayer.watch && sublayer.watch('maxScale', () => {
            if (this.state.activeWhere !== activeWhereSnapshot) return;
            try {
              if (typeof sublayer.definitionExpression !== 'undefined') {
                sublayer.definitionExpression = activeWhereSnapshot;
              }
            } catch {}
          });

          [hVis, hMinScale, hMaxScale].forEach(h => { if (h) this.sublayerHandles.push(h); });
        });

        try { layer.refresh && layer.refresh(); } catch {}
      }
    });
  };

  clearFilter = () => {
    if (!this.mapView) return;
    this.clearLayerDefinitions();
    this.removeAllHandles();

    const currentField = FIELD_RANGES[this.state.selectedField] || FIELD_RANGES.RSRP;

    this.setState({
      activeWhere: null,
      conditions: [],
      activeUsid: null,
      usidInput: '',
      usidError: null,
      tempMin: currentField.def[0],
      tempMax: currentField.def[1]
    });
  };

  render() {
    const { conditions, selectedField, tempMin, tempMax, activeWhere, usidInput, activeUsid, usidError } = this.state;
    const current = FIELD_RANGES[selectedField];
    const legends = KPI_LEGENDS[selectedField];

    return (
      <div style={{ 
        padding: '20px', 
        width: '100%', 
        height: '100%', 
        backgroundColor: '#f8f9fa', 
        overflow: 'auto',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
      }}>
        <JimuMapViewComponent
          useMapWidgetId={this.props.useMapWidgetIds?.[0]}
          onActiveViewChange={this.onActiveViewChange}
        />

        <style>
          {`
            @keyframes fadeIn {
              from { opacity: 0; transform: translateY(-4px); }
              to { opacity: 1; transform: translateY(0); }
            }
          `}
        </style>

        {/* Header */}
        <div style={{ 
          marginBottom: 24,
          paddingBottom: 16,
          borderBottom: '2px solid #dee2e6'
        }}>
          <h2 style={{ 
            margin: 0, 
            fontSize: 24, 
            fontWeight: 700,
            color: '#212529',
            letterSpacing: '-0.5px'
          }}>
            IQI Custom Range Filter
          </h2>
        </div>

        {/* KPI SECTION */}
        <div style={{
          backgroundColor: '#fff',
          borderRadius: 8,
          padding: 20,
          marginBottom: 20,
          boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
          border: '1px solid #e9ecef'
        }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            marginBottom: 16,
            paddingBottom: 12,
            borderBottom: '1px solid #f1f3f5'
          }}>
            <div style={{
              width: 4,
              height: 24,
              backgroundColor: '#0079c1',
              borderRadius: 2,
              marginRight: 12
            }} />
            <h3 style={{ 
              margin: 0, 
              fontSize: 16, 
              fontWeight: 700,
              color: '#212529',
              letterSpacing: '-0.3px'
            }}>
              KPI & Range Selection
            </h3>
          </div>

          {/* KPI Dropdown */}
          <div style={{ marginBottom: 20 }}>
            <label style={{ 
              display: 'block', 
              marginBottom: 8, 
              fontSize: 13, 
              fontWeight: 600,
              color: '#495057',
              textTransform: 'uppercase',
              letterSpacing: '0.5px'
            }}>
              Select KPI 
            </label>
            <select
              value={selectedField}
              onChange={this.onFieldChange}
              style={{ 
                width: '100%', 
                padding: '12px 16px', 
                fontSize: 15, 
                fontWeight: 500,
                border: '2px solid #e9ecef', 
                borderRadius: 6,
                backgroundColor: '#fff',
                color: '#212529',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                outline: 'none'
              }}
              onFocus={(e) => e.currentTarget.style.borderColor = '#0079c1'}
              onBlur={(e) => e.currentTarget.style.borderColor = '#e9ecef'}
            >
              <option value="RSRP">RSRP</option>
              <option value="RSRQ">RSRQ </option>
              <option value="SNR">SNR</option>
            </select>
          </div>

          {/* Slider with Interactive Legend */}
          <DualRangeSlider
            min={current.min}
            max={current.max}
            step={1}
            minValue={tempMin}
            maxValue={tempMax}
            onChange={this.onSliderChange}
            field={selectedField}
            legendSegments={legends}
          />

          {/* Add Condition Button */}
          <button
            onClick={this.addCondition}
            style={{
              width: '100%',
              padding: '14px 20px',
              backgroundColor: '#0079c1',
              color: '#fff',
              border: 'none',
              borderRadius: 6,
              fontSize: 15,
              fontWeight: 600,
              cursor: 'pointer',
              transition: 'all 0.2s ease',
              boxShadow: '0 2px 4px rgba(0,121,193,0.2)',
              marginTop: 16
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.backgroundColor = '#006199';
              e.currentTarget.style.transform = 'translateY(-1px)';
              e.currentTarget.style.boxShadow = '0 4px 8px rgba(0,121,193,0.3)';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.backgroundColor = '#0079c1';
              e.currentTarget.style.transform = 'translateY(0)';
              e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,121,193,0.2)';
            }}
          >
            + Add Filter Condition
          </button>

          {/* Active Conditions */}
          {conditions.length > 0 && (
            <div style={{ marginTop: 20 }}>
              <div style={{
                display: 'flex',
                alignItems: 'center',
                marginBottom: 12
              }}>
                <span style={{ 
                  fontSize: 13, 
                  fontWeight: 600,
                  color: '#495057',
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>
                  Active Conditions
                </span>
                <span style={{
                  marginLeft: 8,
                  padding: '2px 8px',
                  backgroundColor: '#0079c1',
                  color: '#fff',
                  borderRadius: 12,
                  fontSize: 11,
                  fontWeight: 700
                }}>
                  {conditions.length}
                </span>
              </div>
              {conditions.map((cond, idx) => (
                <div
                  key={cond.id}
                  style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '12px 16px',
                    backgroundColor: '#f8f9fa',
                    borderLeft: '3px solid #0079c1',
                    borderRadius: 6,
                    marginBottom: 10,
                    fontSize: 14,
                    transition: 'all 0.2s ease'
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.backgroundColor = '#e9ecef';
                    e.currentTarget.style.transform = 'translateX(4px)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.backgroundColor = '#f8f9fa';
                    e.currentTarget.style.transform = 'translateX(0)';
                  }}
                >
                  <span style={{ color: '#495057', fontWeight: 500 }}>
                    {idx > 0 && <span style={{ 
                      fontWeight: 700, 
                      color: '#6c757d',
                      marginRight: 8 
                    }}>AND</span>}
                    <span style={{ 
                      fontWeight: 700, 
                      color: '#212529' 
                    }}>{cond.field}</span>
                    {' '}
                    <span style={{ color: '#6c757d', fontWeight: 400 }}>between</span>
                    {' '}
                    <span style={{ 
                      fontWeight: 700, 
                      color: '#0079c1',
                      fontVariantNumeric: 'tabular-nums'
                    }}>{cond.min}</span>
                    {' '}
                    <span style={{ color: '#6c757d', fontWeight: 400 }}>and</span>
                    {' '}
                    <span style={{ 
                      fontWeight: 700, 
                      color: '#0079c1',
                      fontVariantNumeric: 'tabular-nums'
                    }}>{cond.max}</span>
                  </span>
                  <button
                    onClick={() => this.removeCondition(cond.id)}
                    style={{
                      padding: '6px 10px',
                      backgroundColor: '#dc3545',
                      color: 'white',
                      border: 'none',
                      borderRadius: 4,
                      fontSize: 12,
                      fontWeight: 600,
                      cursor: 'pointer',
                      transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = '#c82333';
                      e.currentTarget.style.transform = 'scale(1.05)';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = '#dc3545';
                      e.currentTarget.style.transform = 'scale(1)';
                    }}
                  >
                    Remove
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* USID SECTION */}
        <div style={{
          backgroundColor: '#fff',
          borderRadius: 8,
          padding: 20,
          marginBottom: 20,
          boxShadow: '0 2px 8px rgba(0,0,0,0.08)',
          border: '1px solid #e9ecef'
        }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            marginBottom: 16,
            paddingBottom: 12,
            borderBottom: '1px solid #f1f3f5'
          }}>
            <div style={{
              width: 4,
              height: 24,
              backgroundColor: '#28a745',
              borderRadius: 2,
              marginRight: 12
            }} />
            <h3 style={{ 
              margin: 0, 
              fontSize: 16, 
              fontWeight: 700,
              color: '#212529',
              letterSpacing: '-0.3px'
            }}>
              USID Filter
            </h3>
          </div>

          <label style={{ 
            display: 'block', 
            marginBottom: 8, 
            fontSize: 13, 
            fontWeight: 600,
            color: '#495057',
            letterSpacing: '0.5px'
          }}>
            Enter USID or Comma-Separated USID(s)
          </label>
          
          <div style={{ display: 'flex', gap: 10, marginBottom: 12 }}>
            <input
              type="text"
              value={usidInput}
              onChange={this.onUsidInputChange}
              onKeyDown={this.onUsidKeyDown}
              placeholder="Enter USID(s) here"
              style={{ 
                flex: 1, 
                padding: '12px 16px', 
                fontSize: 14, 
                border: '2px solid #e9ecef', 
                borderRadius: 6,
                outline: 'none',
                transition: 'all 0.2s ease',
                fontFamily: 'inherit'
              }}
              onFocus={(e) => e.currentTarget.style.borderColor = '#28a745'}
              onBlur={(e) => e.currentTarget.style.borderColor = '#e9ecef'}
            />
            <button
              onClick={this.applyUsidFilter}
              style={{
                padding: '12px 20px',
                backgroundColor: '#28a745',
                color: '#fff',
                border: 'none',
                borderRadius: 6,
                fontSize: 14,
                fontWeight: 600,
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                boxShadow: '0 2px 4px rgba(40,167,69,0.2)',
                whiteSpace: 'nowrap'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.backgroundColor = '#218838';
                e.currentTarget.style.transform = 'translateY(-1px)';
                e.currentTarget.style.boxShadow = '0 4px 8px rgba(40,167,69,0.3)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.backgroundColor = '#28a745';
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = '0 2px 4px rgba(40,167,69,0.2)';
              }}
            >
              Apply
            </button>
            <button
              onClick={this.clearUsid}
              disabled={!usidInput && !(activeUsid && activeUsid.length)}
              style={{
                padding: '12px 20px',
                backgroundColor: usidInput || (activeUsid && activeUsid.length) ? '#6c757d' : '#e9ecef',
                color: usidInput || (activeUsid && activeUsid.length) ? '#fff' : '#adb5bd',
                border: 'none',
                borderRadius: 6,
                fontSize: 14,
                fontWeight: 600,
                cursor: usidInput || (activeUsid && activeUsid.length) ? 'pointer' : 'not-allowed',
                transition: 'all 0.2s ease',
                whiteSpace: 'nowrap'
              }}
              onMouseEnter={(e) => {
                if (usidInput || (activeUsid && activeUsid.length)) {
                  e.currentTarget.style.backgroundColor = '#5a6268';
                  e.currentTarget.style.transform = 'translateY(-1px)';
                }
              }}
              onMouseLeave={(e) => {
                if (usidInput || (activeUsid && activeUsid.length)) {
                  e.currentTarget.style.backgroundColor = '#6c757d';
                  e.currentTarget.style.transform = 'translateY(0)';
                }
              }}
            >
              Clear
            </button>
          </div>

          {activeUsid && activeUsid.length > 0 && (
            <div style={{
              padding: '12px 16px',
              backgroundColor: '#d4edda',
              borderLeft: '3px solid #28a745',
              borderRadius: 6,
              fontSize: 13,
              color: '#155724'
            }}>
              <div style={{ fontWeight: 600, marginBottom: 4 }}>
                Active USID Filter
              </div>
              <div style={{ fontWeight: 500 }}>
                Filtering by: <span style={{ fontWeight: 700 }}>{activeUsid.join(', ')}</span>
              </div>
            </div>
          )}

          {usidError && (
            <div style={{
              marginTop: 8,
              padding: '12px 16px',
              backgroundColor: '#f8d7da',
              borderLeft: '3px solid #dc3545',
              borderRadius: 6,
              fontSize: 13,
              color: '#721c24',
              fontWeight: 500
            }}>
              {usidError}
            </div>
          )}
        </div>

        {/* ACTION BUTTONS */}
        <div style={{ display: 'flex', gap: 12 }}>
          <button
            onClick={this.clearFilter}
            disabled={!activeWhere}
            style={{
              flex: 1,
              padding: '14px 20px',
              backgroundColor: activeWhere ? '#dc3545' : '#e9ecef',
              color: activeWhere ? '#fff' : '#adb5bd',
              border: 'none',
              borderRadius: 6,
              fontSize: 15,
              fontWeight: 600,
              cursor: activeWhere ? 'pointer' : 'not-allowed',
              transition: 'all 0.2s ease',
              boxShadow: activeWhere ? '0 2px 4px rgba(220,53,69,0.2)' : 'none'
            }}
            onMouseEnter={(e) => {
              if (activeWhere) {
                e.currentTarget.style.backgroundColor = '#c82333';
                e.currentTarget.style.transform = 'translateY(-1px)';
                e.currentTarget.style.boxShadow = '0 4px 8px rgba(220,53,69,0.3)';
              }
            }}
            onMouseLeave={(e) => {
              if (activeWhere) {
                e.currentTarget.style.backgroundColor = '#dc3545';
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = '0 2px 4px rgba(220,53,69,0.2)';
              }
            }}
          >
            Clear All Filters
          </button>
        </div>

        {/* INFO PANEL */}
        {/* <div
          style={{
            marginTop: 24,
            padding: 16,
            backgroundColor: '#e7f3ff',
            borderLeft: '4px solid #0079c1',
            borderRadius: 6,
            fontSize: 13,
            lineHeight: 1.6,
            color: '#004085'
          }}
        >
          <div style={{ fontWeight: 700, marginBottom: 8, fontSize: 14 }}>
            CQX Quality Thresholds
          </div>
          <div style={{ fontWeight: 400 }}>
            Weighted acceptable coverage (RSRP greater than -115 dBm) and poor signal quality (scaled RSRQ &lt; -18 dB) for 4G and 5G devices on 4G network.
          </div> */}
        {/* </div> */}
      </div>
    );
  }
}
