/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "url/vector/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  is3D: boolean;
}

export default class Widget extends React.PureComponent<any, State> {
  private viewDiv: HTMLDivElement;
  private view: any;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget yÃ¼kleniyor...",
      is3D: true // 3D mode aktif
    };
  }

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.view) {
      this.view.destroy();
    }
  }

  loadArcGISAPI = () => {
    this.setState({ message: "ğŸ“¦ ArcGIS API yÃ¼kleniyor..." });

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.onload = () => {
      this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
      this.createScene();
    };
    document.head.appendChild(script);
  };

  createScene = () => {
    this.setState({ message: "ğŸŒ 3D Scene oluÅŸturuluyor..." });

    (window as any).require([
      'esri/Map',
      'esri/views/SceneView',
      'esri/layers/VectorTileLayer',
      'esri/request'
    ], (Map, SceneView, VectorTileLayer, esriRequest) => {
      
      const map = new Map({
        basemap: 'dark-gray-vector',
        ground: 'world-elevation' // 3D terrain
      });

      // SceneView (3D)
      this.view = new SceneView({
        container: this.viewDiv,
        map: map,
        camera: {
          position: {
            longitude: 32,
            latitude: 39,
            z: 500000 // YÃ¼kseklik (metre)
          },
          tilt: 45, // Kamera aÃ§Ä±sÄ±
          heading: 0
        },
        qualityProfile: "high", // YÃ¼ksek kalite rendering
        environment: {
          atmosphere: {
            quality: "high"
          },
          lighting: {
            date: new Date(),
            directShadowsEnabled: true,
            ambientOcclusionEnabled: true
          }
        }
      });

      this.setState({ message: "âœ… 3D Scene oluÅŸturuldu! MVT yÃ¼kleniyor..." });

      // Fetch interceptor
      const originalFetch = window.fetch;
      window.fetch = (url, options = {}) => {
        const urlStr = url.toString();
        if (urlStr.includes(new URL(MVT_STYLE_URL).hostname)) {
          return originalFetch(url, {
            ...options,
            headers: {
              ...(options['headers'] || {}),
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          });
        }
        return originalFetch(url, options);
      };

      esriRequest(MVT_STYLE_URL, {
        headers: {
          'Authorization': `Bearer ${MANUAL_BEARER}`
        },
        responseType: 'json'
      }).then(response => {
        const styleJson = response.data;
        
        console.log("Style JSON loaded:", styleJson);

        // Siyah Ã§izgileri dÃ¼zelt - line stroke ekle
        if (styleJson.layers && Array.isArray(styleJson.layers)) {
          styleJson.layers.forEach((layer: any) => {
            if (layer.type === 'fill' && layer.paint) {
              // Fill outline ekle - siyah Ã§izgileri Ã¶nler
              if (!layer.paint['fill-outline-color']) {
                layer.paint['fill-outline-color'] = layer.paint['fill-color'];
              }
              // Anti-aliasing iÃ§in
              layer.paint['fill-antialias'] = true;
            }
            
            if (layer.type === 'line' && layer.paint) {
              // Line width artÄ±r - gÃ¶rÃ¼nÃ¼rlÃ¼k iÃ§in
              if (!layer.paint['line-width']) {
                layer.paint['line-width'] = 0.5;
              }
            }
          });
        }

        this.setState({ message: "ğŸ“„ Style optimized for 3D" });

        const mvtLayer = new VectorTileLayer({
          style: styleJson,
          // 3D iÃ§in elevation mode
          elevationInfo: {
            mode: "on-the-ground" // Zemin Ã¼zerinde render et
          },
          // Rendering quality
          labelsVisible: true,
          opacity: 0.85 // Hafif transparan - 3D objelerle uyum iÃ§in
        });

        mvtLayer.when(() => {
          this.setState({ message: "âœ… MVT Layer 3D'de yÃ¼klendi!" });
          console.log("Layer info:", mvtLayer.currentStyleInfo);
        }).catch(err => {
          this.setState({ message: `âŒ ${err.message}` });
          console.error(err);
        });

        map.add(mvtLayer);
        
      }).catch(err => {
        this.setState({ message: `âŒ ${err.message}` });
        console.error(err);
      });
    });
  };

  toggleView = () => {
    this.setState({ is3D: !this.state.is3D }, () => {
      if (this.view) {
        this.view.destroy();
      }
      if (this.state.is3D) {
        this.createScene();
      } else {
        this.createMap();
      }
    });
  };

  createMap = () => {
    // 2D fallback (isteÄŸe baÄŸlÄ±)
    this.setState({ message: "ğŸ—ºï¸ 2D Map modu..." });
    // MapView kodu buraya gelir
  };

  render() {
    const { message, is3D } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.viewDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.85)",
          color: "white",
          padding: "15px 20px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px",
          boxShadow: "0 4px 12px rgba(0,0,0,0.5)"
        }}>
          <div style={{ display: "flex", alignItems: "center", gap: "10px" }}>
            <strong>ğŸŒ 3D MVT Widget</strong>
            <span style={{ 
              fontSize: "10px", 
              padding: "2px 8px", 
              background: is3D ? "#00aa00" : "#666",
              borderRadius: "4px"
            }}>
              {is3D ? "3D" : "2D"}
            </span>
          </div>
          <div style={{ marginTop: "10px", fontSize: "11px" }}>{message}</div>
        </div>
      </div>
    );
  }
}
