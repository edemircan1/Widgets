/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
  debugInfo: string;
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;
  private vectorLayer: any;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget y√ºkleniyor...",
      currentZoom: 15,
      debugInfo: ""
    };
  }

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  loadArcGISAPI = () => {
    this.setState({ message: "üì¶ ArcGIS API y√ºkleniyor..." });

    if ((window as any).require) {
      this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
      this.createMap();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const existing = document.querySelector(`script[data-arcgis-api="${ARCGIS_API_VERSION}"]`) as HTMLScriptElement | null;
    if (existing) {
      existing.addEventListener('load', () => {
        this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
        this.createMap();
      });
      return;
    }

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.setAttribute('data-arcgis-api', ARCGIS_API_VERSION);
    script.onload = () => {
      this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
      this.createMap();
    };
    script.onerror = () => {
      this.setState({ message: "‚ùå ArcGIS API y√ºklenemedi" });
    };
    document.head.appendChild(script);
  };

  createMap = () => {
    this.setState({ message: "üó∫Ô∏è Map olu≈üturuluyor..." });

    if (!this.mapDiv) {
      setTimeout(() => this.createMap(), 50);
      return;
    }

    if (!(window as any).require) {
      this.setState({ message: "‚ùå ArcGIS API loader bulunamadƒ±" });
      return;
    }

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer',
      'esri/request'
    ], (Map, MapView, VectorTileLayer, esriRequest) => {
      
      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39],
        zoom: 15,
        constraints: {
          snapToZoom: false,
          minZoom: 3,
          maxZoom: 22,
          rotationEnabled: false
        }
      });

      this.mapView.when(() => {
        const container = this.mapView.container as HTMLElement;
        
        container.addEventListener('wheel', (event: WheelEvent) => {
          event.preventDefault();
          
          const currentZoom = this.mapView.zoom;
          const delta = event.deltaY;
          const zoomChange = delta > 0 ? -0.2 : 0.2;
          const newZoom = Math.max(3, Math.min(22, currentZoom + zoomChange));
          
          this.mapView.goTo({
            zoom: newZoom
          }, {
            duration: 100
          });
        }, { passive: false });
      });

      this.mapView.watch('zoom', (newZoom) => {
        this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
      });

      this.setState({ message: "‚úÖ Map hazƒ±r! Style JSON test ediliyor..." });

      // Fetch override
      const originalFetch = window.fetch;
      window.fetch = (url, options = {}) => {
        const urlStr = url.toString();
        if (urlStr.includes('abc.com') || urlStr.includes('/styles/')) {
          return originalFetch(url, {
            ...options,
            headers: {
              ...(options['headers'] || {}),
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          });
        }
        return originalFetch(url, options);
      };

      // üîç HARDCORE DEBUG: Style JSON'u birden fazla y√∂ntemle test et
      esriRequest(MVT_STYLE_URL, {
        headers: {
          'Authorization': `Bearer ${MANUAL_BEARER}`
        },
        responseType: 'json'
      }).then(response => {
        const originalStyle = response.data;
        
        console.log("=" .repeat(80));
        console.log("üîç STYLE JSON DEBUG");
        console.log("=" .repeat(80));
        console.log("Original Style:", JSON.stringify(originalStyle, null, 2));
        
        // Test 1: Orijinal style
        console.log("\nüìã TEST 1: Original Style (as-is)");
        this.testStyle(originalStyle, "Original", VectorTileLayer, map);
        
        // Test 2: Basit renkler (expression yok)
        console.log("\nüìã TEST 2: Simple Static Colors");
        const simpleStyle = this.createSimpleStyle(originalStyle);
        this.testStyle(simpleStyle, "Simple", VectorTileLayer, map);
        
        // Test 3: Tek layer test
        console.log("\nüìã TEST 3: Single Layer Test");
        const singleLayerStyle = this.createSingleLayerStyle(originalStyle);
        this.testStyle(singleLayerStyle, "Single", VectorTileLayer, map);
        
        this.setState({ 
          message: "üîç 3 farklƒ± style test ediliyor...",
          debugInfo: "Check console for detailed logs"
        });
        
      }).catch(err => {
        console.error("‚ùå Fetch error:", err);
        this.setState({ message: `‚ùå Fetch error: ${err.message}` });
      });
    });
  };

  // Test 1 yardƒ±mcƒ±sƒ±: Orijinal style'ƒ± test et
  testStyle = (styleJson: any, label: string, VectorTileLayer: any, map: any) => {
    const layer = new VectorTileLayer({
      style: styleJson,
      title: `Test: ${label}`,
      opacity: 0.8
    });

    layer.when(() => {
      console.log(`‚úÖ ${label} layer loaded`);
      console.log(`  - Style:`, layer.style);
      console.log(`  - CurrentStyleInfo:`, layer.currentStyleInfo);
      console.log(`  - Visible:`, layer.visible);
      console.log(`  - Loaded:`, layer.loaded);
    }).catch(err => {
      console.error(`‚ùå ${label} layer error:`, err);
    });

    map.add(layer);
    
    if (label === "Original") {
      this.vectorLayer = layer;
    }
  };

  // Test 2: Basit statik renkler
  createSimpleStyle = (originalStyle: any) => {
    return {
      version: 8,
      sources: originalStyle.sources,
      layers: [
        {
          id: "simple_fill",
          type: "fill",
          source: "coverage_15z",
          "source-layer": "data",
          minzoom: 0,
          maxzoom: 24,
          paint: {
            "fill-color": "#FF0000", // Kƒ±rmƒ±zƒ± - expression yok
            "fill-opacity": 0.7
          }
        }
      ]
    };
  };

  // Test 3: Tek layer, basit case expression
  createSingleLayerStyle = (originalStyle: any) => {
    return {
      version: 8,
      sources: { coverage_15z: originalStyle.sources.coverage_15z },
      layers: [
        {
          id: "single_case_fill",
          type: "fill",
          source: "coverage_15z",
          "source-layer": "data",
          minzoom: 0,
          maxzoom: 24,
          paint: {
            "fill-color": [
              "case",
              ["<", ["get", "rsrp_dbm"], -100], "#313695", // Mavi
              ["<", ["get", "rsrp_dbm"], -80], "#FDAE61",  // Turuncu
              "#D73027" // Kƒ±rmƒ±zƒ± (default)
            ],
            "fill-opacity": 0.7
          }
        }
      ]
    };
  };

  render() {
    const { message, currentZoom, debugInfo } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        {/* Control Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          right: "10px",
          background: "rgba(0,0,0,0.95)",
          color: "white",
          padding: "20px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px",
          minWidth: "300px",
          maxWidth: "400px"
        }}>
          <div style={{ marginBottom: "15px", textAlign: "center", fontWeight: "bold", color: "#FF6B6B", fontSize: "14px" }}>
            üîç HARDCORE DEBUG MODE
          </div>
          
          <div style={{ 
            background: "rgba(255,255,255,0.1)", 
            padding: "10px", 
            borderRadius: "5px",
            marginBottom: "10px"
          }}>
            <div style={{ fontSize: "10px", color: "#aaa", marginBottom: "5px" }}>
              Current Zoom
            </div>
            <div style={{ fontSize: "24px", fontWeight: "bold", color: "#FFD700" }}>
              {currentZoom}
            </div>
          </div>

          <div style={{ fontSize: "11px", marginBottom: "10px", lineHeight: "1.5" }}>
            <strong style={{ color: "#4CAF50" }}>Testing 3 Approaches:</strong>
            <div style={{ marginTop: "5px", paddingLeft: "10px" }}>
              1. Original Style JSON<br/>
              2. Simple Static Colors<br/>
              3. Case Expression Colors
            </div>
          </div>

          <div style={{ fontSize: "10px", color: "#FFD700", marginTop: "10px", padding: "10px", background: "rgba(255,215,0,0.1)", borderRadius: "4px" }}>
            ‚ö†Ô∏è Open Console (F12)<br/>
            Check layer load status & errors
          </div>

          <div style={{ display: "flex", gap: "10px", marginTop: "15px" }}>
            <button
              onClick={() => {
                if (this.mapView) {
                  this.mapView.goTo({ zoom: this.mapView.zoom - 0.5 }, { duration: 200 });
                }
              }}
              style={{
                flex: 1,
                padding: "10px",
                fontSize: "16px",
                background: "#f44336",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer"
              }}
            >
              -
            </button>
            <button
              onClick={() => {
                if (this.mapView) {
                  this.mapView.goTo({ zoom: this.mapView.zoom + 0.5 }, { duration: 200 });
                }
              }}
              style={{
                flex: 1,
                padding: "10px",
                fontSize: "16px",
                background: "#4CAF50",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer"
              }}
            >
              +
            </button>
          </div>
        </div>

        {/* Status Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.9)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "11px",
          maxWidth: "300px"
        }}>
          <strong style={{ color: "#FF6B6B" }}>üîß DEBUG STATUS:</strong>
          <div style={{ marginTop: "10px", color: "#FFD700" }}>{message}</div>
          {debugInfo && (
            <div style={{ marginTop: "10px", fontSize: "10px", color: "#888" }}>
              {debugInfo}
            </div>
          )}
          <div style={{ marginTop: "10px", paddingTop: "10px", borderTop: "1px solid rgba(255,255,255,0.2)", fontSize: "10px" }}>
            <div style={{ color: "#4CAF50" }}>
              Expected Grid: {
                currentZoom < 7 ? "10km (3z)" :
                currentZoom < 11 ? "1km (7z)" :
                currentZoom < 15 ? "100m (11z)" : "10m (15z)"
              }
            </div>
            <div style={{ marginTop: "5px", color: "#888" }}>
              If you see RED/ORANGE/BLUE polygons,<br/>
              colors are working!
            </div>
          </div>
        </div>
      </div>
    );
  }
}
