/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "https://your-api.com/api/vector/styles/all/style.json?coverageLayer=rsrp_dbm_poly";
const MANUAL_BEARER = "your_bearer_token_here";

interface State {
  message: string;
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;
  private originalFetch = window.fetch;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget y√ºkleniyor..."
    };
  }

  componentDidMount() {
    // Fetch interceptor
    const self = this;
    window.fetch = function(url, options = {}) {
      const urlStr = url.toString();
      if (urlStr.includes('your-api.com')) {
        return self.originalFetch(url, {
          ...options,
          headers: {
            ...(options['headers'] || {}),
            'Authorization': `Bearer ${MANUAL_BEARER}`
          }
        });
      }
      return self.originalFetch(url, options);
    };

    // Map'i olu≈ütur
    this.createMap();
  }

  componentWillUnmount() {
    window.fetch = this.originalFetch;
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  createMap = () => {
    this.setState({ message: "üó∫Ô∏è Map olu≈üturuluyor..." });

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer'
    ], (Map, MapView, VectorTileLayer) => {
      
      this.setState({ message: "üì¶ ArcGIS mod√ºlleri y√ºklendi" });

      // Basemap ile map olu≈ütur
      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      // MapView olu≈ütur
      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39], // T√ºrkiye merkez
        zoom: 6
      });

      this.setState({ message: "‚úÖ Map olu≈üturuldu! MVT y√ºkleniyor..." });

      // MVT layer ekle
      fetch(MVT_STYLE_URL)
        .then(res => {
          this.setState({ message: `üì° Style fetch: ${res.status}` });
          return res.json();
        })
        .then(styleJson => {
          this.setState({ message: "üìÑ Style JSON alƒ±ndƒ±" });
          console.log("STYLE JSON:", styleJson);

          const mvtLayer = new VectorTileLayer({
            style: styleJson
          });

          map.add(mvtLayer);
          this.setState({ message: "‚úÖ MVT Layer eklendi!" });
        })
        .catch(err => {
          this.setState({ message: `‚ùå HATA: ${err.message}` });
          console.error("Detaylƒ± hata:", err);
        });
    });
  };

  render() {
    const { message } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        {/* Map container */}
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        {/* Debug overlay */}
        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.8)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px"
        }}>
          <div><strong>MVT Widget:</strong></div>
          <div style={{ marginTop: "10px" }}>{message}</div>
        </div>
      </div>
    );
  }
}
