/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
  testMode: number; // 0: static, 1: case, 2: step
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;
  private currentLayer: any;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget yÃ¼kleniyor...",
      currentZoom: 15,
      testMode: 0 // BaÅŸlangÄ±Ã§ta statik renk
    };
  }

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  loadArcGISAPI = () => {
    this.setState({ message: "ðŸ“¦ ArcGIS API yÃ¼kleniyor..." });

    if ((window as any).require) {
      this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
      this.createMap();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const existing = document.querySelector(`script[data-arcgis-api="${ARCGIS_API_VERSION}"]`) as HTMLScriptElement | null;
    if (existing) {
      existing.addEventListener('load', () => {
        this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
        this.createMap();
      });
      return;
    }

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.setAttribute('data-arcgis-api', ARCGIS_API_VERSION);
    script.onload = () => {
      this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
      this.createMap();
    };
    script.onerror = () => {
      this.setState({ message: "âŒ ArcGIS API yÃ¼klenemedi" });
    };
    document.head.appendChild(script);
  };

  createMap = () => {
    this.setState({ message: "ðŸ—ºï¸ Map oluÅŸturuluyor..." });

    if (!this.mapDiv) {
      setTimeout(() => this.createMap(), 50);
      return;
    }

    if (!(window as any).require) {
      this.setState({ message: "âŒ ArcGIS API loader bulunamadÄ±" });
      return;
    }

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer',
      'esri/request'
    ], (Map, MapView, VectorTileLayer, esriRequest) => {
      
      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39],
        zoom: 15,
        constraints: {
          snapToZoom: false,
          minZoom: 3,
          maxzoom: 22,
          rotationEnabled: false
        },
        navigation: {
          mouseWheelZoomEnabled: true,
          browserTouchPanEnabled: true
        }
      });

      this.mapView.when(() => {
        const container = this.mapView.container as HTMLElement;
        
        container.addEventListener('wheel', (event: WheelEvent) => {
          event.preventDefault();
          
          const currentZoom = this.mapView.zoom;
          const delta = event.deltaY;
          const zoomChange = delta > 0 ? -0.2 : 0.2;
          const newZoom = Math.max(3, Math.min(22, currentZoom + zoomChange));
          
          this.mapView.goTo({
            zoom: newZoom
          }, {
            duration: 100
          });
        }, { passive: false });
      });

      this.mapView.watch('zoom', (newZoom) => {
        this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
      });

      this.setState({ message: "âœ… Map oluÅŸturuldu! MVT yÃ¼kleniyor..." });

      // Fetch override
      const originalFetch = window.fetch;
      window.fetch = (url, options = {}) => {
        const urlStr = url.toString();
        if (urlStr.includes(new URL(MVT_STYLE_URL).hostname)) {
          return originalFetch(url, {
            ...options,
            headers: {
              ...(options['headers'] || {}),
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          });
        }
        return originalFetch(url, options);
      };

      // Style JSON fetch
      esriRequest(MVT_STYLE_URL, {
        headers: {
          'Authorization': `Bearer ${MANUAL_BEARER}`
        },
        responseType: 'json'
      }).then(response => {
        const originalStyle = response.data;
        
        // Ä°lk yÃ¼kleme - statik renkle
        this.loadLayerWithMode(0, originalStyle, VectorTileLayer, map);
        
      }).catch(err => {
        this.setState({ message: `âŒ Fetch error: ${err.message}` });
        console.error("FETCH HATASI:", err);
      });
    });
  };

  loadLayerWithMode = (mode: number, originalStyle: any, VectorTileLayer: any, map: any) => {
    // Eski layer'Ä± kaldÄ±r
    if (this.currentLayer) {
      map.remove(this.currentLayer);
    }

    let fixedStyle;
    
    if (mode === 0) {
      // MODE 0: STATÄ°K RENKLER - Her layer farklÄ± sabit renk
      this.setState({ message: "ðŸŽ¨ TEST 1: Statik renkler" });
      fixedStyle = {
        version: 8,
        sources: originalStyle.sources,
        layers: [
          {
            id: "fill_15z",
            type: "fill",
            source: "coverage_15z",
            "source-layer": "data",
            minzoom: 15,
            maxzoom: 24,
            paint: {
              "fill-color": "#FF0000", // KÄ±rmÄ±zÄ±
              "fill-opacity": 0.7
            }
          },
          {
            id: "fill_11z",
            type: "fill",
            source: "coverage_11z",
            "source-layer": "data",
            minzoom: 11,
            maxzoom: 15,
            paint: {
              "fill-color": "#00FF00", // YeÅŸil
              "fill-opacity": 0.7
            }
          },
          {
            id: "fill_7z",
            type: "fill",
            source: "coverage_7z",
            "source-layer": "data",
            minzoom: 7,
            maxzoom: 11,
            paint: {
              "fill-color": "#0000FF", // Mavi
              "fill-opacity": 0.7
            }
          },
          {
            id: "fill_3z",
            type: "fill",
            source: "coverage_3z",
            "source-layer": "data",
            minzoom: 3,
            maxzoom: 7,
            paint: {
              "fill-color": "#FFFF00", // SarÄ±
              "fill-opacity": 0.7
            }
          }
        ]
      };
      console.log("ðŸ”´ Static colors: Red(15z), Green(11z), Blue(7z), Yellow(3z)");
      
    } else if (mode === 1) {
      // MODE 1: CASE EXPRESSION
      this.setState({ message: "ðŸŽ¨ TEST 2: Case expression" });
      fixedStyle = {
        version: 8,
        sources: originalStyle.sources,
        layers: originalStyle.layers.map(layer => {
          if (layer.type === 'fill') {
            return {
              ...layer,
              paint: {
                "fill-color": [
                  "case",
                  ["<", ["get", "rsrp_dbm"], -100], "#313695",
                  ["<", ["get", "rsrp_dbm"], -75], "#FDAE61",
                  "#D73027"
                ],
                "fill-opacity": 0.7
              }
            };
          }
          return layer;
        })
      };
      console.log("ðŸŸ  Case expression: Blue(<-100), Orange(<-75), Red(default)");
      
    } else {
      // MODE 2: STEP EXPRESSION
      this.setState({ message: "ðŸŽ¨ TEST 3: Step expression" });
      fixedStyle = {
        version: 8,
        sources: originalStyle.sources,
        layers: originalStyle.layers.map(layer => {
          if (layer.type === 'fill') {
            return {
              ...layer,
              paint: {
                "fill-color": [
                  "step",
                  ["get", "rsrp_dbm"],
                  "#313695", // default
                  -100, "#FDAE61",
                  -75, "#D73027"
                ],
                "fill-opacity": 0.7
              }
            };
          }
          return layer;
        })
      };
      console.log("ðŸŸ¢ Step expression: Blue(default), Orange(-100+), Red(-75+)");
    }

    console.log("Generated style:", fixedStyle);

    const layer = new VectorTileLayer({
      style: fixedStyle,
      title: `Test Mode ${mode}`
    });

    layer.when(() => {
      console.log(`âœ… Mode ${mode} layer loaded`);
    }).catch(err => {
      console.error(`âŒ Mode ${mode} error:`, err);
    });

    map.add(layer);
    this.currentLayer = layer;
  };

  switchTestMode = (newMode: number) => {
    this.setState({ testMode: newMode });
    
    if (this.mapView) {
      (window as any).require([
        'esri/layers/VectorTileLayer',
        'esri/request'
      ], (VectorTileLayer, esriRequest) => {
        esriRequest(MVT_STYLE_URL, {
          headers: { 'Authorization': `Bearer ${MANUAL_BEARER}` },
          responseType: 'json'
        }).then(response => {
          this.loadLayerWithMode(newMode, response.data, VectorTileLayer, this.mapView.map);
        });
      });
    }
  };

  render() {
    const { message, currentZoom, testMode } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        {/* Test Mode Switcher */}
        <div style={{
          position: "absolute",
          top: "10px",
          right: "10px",
          background: "rgba(0,0,0,0.9)",
          color: "white",
          padding: "20px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px",
          minWidth: "250px"
        }}>
          <div style={{ marginBottom: "15px", textAlign: "center", fontWeight: "bold", color: "#FFD700" }}>
            ðŸ§ª COLOR TEST
          </div>
          
          <div style={{ 
            background: "rgba(255,255,255,0.1)", 
            padding: "10px", 
            borderRadius: "5px",
            marginBottom: "15px",
            textAlign: "center"
          }}>
            <div style={{ fontSize: "10px", color: "#aaa", marginBottom: "5px" }}>
              Zoom Level
            </div>
            <div style={{ fontSize: "24px", fontWeight: "bold", color: "#FFD700" }}>
              {currentZoom}
            </div>
          </div>

          <div style={{ marginBottom: "15px" }}>
            <div style={{ fontSize: "11px", color: "#aaa", marginBottom: "8px" }}>Select Test:</div>
            <button
              onClick={() => this.switchTestMode(0)}
              style={{
                width: "100%",
                padding: "10px",
                marginBottom: "5px",
                background: testMode === 0 ? "#4CAF50" : "#555",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontSize: "11px"
              }}
            >
              TEST 1: Static Colors
            </button>
            <button
              onClick={() => this.switchTestMode(1)}
              style={{
                width: "100%",
                padding: "10px",
                marginBottom: "5px",
                background: testMode === 1 ? "#4CAF50" : "#555",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontSize: "11px"
              }}
            >
              TEST 2: Case Expression
            </button>
            <button
              onClick={() => this.switchTestMode(2)}
              style={{
                width: "100%",
                padding: "10px",
                background: testMode === 2 ? "#4CAF50" : "#555",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontSize: "11px"
              }}
            >
              TEST 3: Step Expression
            </button>
          </div>

          <div style={{ fontSize: "10px", color: "#888", marginTop: "10px", lineHeight: "1.4" }}>
            <strong>Expected:</strong><br/>
            Test 1: Red/Green/Blue/Yellow<br/>
            Test 2-3: Data-driven colors
          </div>
        </div>

        {/* Status Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.8)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px"
        }}>
          <strong>ðŸŽ¨ Active Test:</strong>
          <div style={{ marginTop: "10px", color: "#FFD700" }}>{message}</div>
          <div style={{ marginTop: "10px", fontSize: "10px", color: "#888" }}>
            Zoom: {
              currentZoom < 7 ? "Yellow (3z)" :
              currentZoom < 11 ? "Blue (7z)" :
              currentZoom < 15 ? "Green (11z)" : "Red (15z)"
            }
          </div>
        </div>
      </div>
    );
  }
}
