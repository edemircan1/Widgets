import { React } from "jimu-core";
import { JimuMapViewComponent, JimuMapView } from "jimu-arcgis";

const MVT_STYLE_URL = "https://your-api.com/api/vector/styles/all/style.json?coverageLayer=rsrp_dbm_poly";
const MANUAL_BEARER = "your_bearer_token_here";

export default class Widget extends React.PureComponent<any, any> {
  private mvtLayer: any = null;
  private originalFetch: any = null;

  componentDidMount() {
    // Global fetch'i intercept et - T√úM isteklere Bearer ekle
    this.originalFetch = window.fetch;
    window.fetch = (url, options = {}) => {
      // API domain'ine giden t√ºm isteklere Authorization ekle
      const urlString = url.toString();
      if (urlString.includes('your-api.com')) { // Buraya kendi domain'ini yaz
        const newOptions = {
          ...options,
          headers: {
            ...(options.headers || {}),
            'Authorization': `Bearer ${MANUAL_BEARER}`
          }
        };
        console.log("üîê Auth eklendi:", urlString);
        return this.originalFetch(url, newOptions);
      }
      return this.originalFetch(url, options);
    };
  }

  componentWillUnmount() {
    // Original fetch'i geri y√ºkle
    if (this.originalFetch) {
      window.fetch = this.originalFetch;
    }
    if (this.mvtLayer && this.state?.jimuMapView) {
      this.state.jimuMapView.view.map.remove(this.mvtLayer);
    }
  }

  onActiveViewChange = async (jmv: JimuMapView) => {
    console.log("‚úÖ Map aktif");
    if (jmv) {
      await this.loadMVTLayer(jmv);
    }
  };

  loadMVTLayer = async (jmv: JimuMapView) => {
    try {
      console.log("üîÑ VectorTileLayer y√ºkleniyor...");
      
      const VectorTileLayer = (await import("esri/layers/VectorTileLayer")).default;
      
      console.log("‚úÖ Mod√ºl y√ºklendi, style fetch ediliyor...");

      const response = await fetch(MVT_STYLE_URL);
      
      console.log("üì° Status:", response.status);
      const styleJson = await response.json();
      console.log("üìÑ Style:", styleJson);

      this.mvtLayer = new VectorTileLayer({
        style: styleJson
      });

      jmv.view.map.add(this.mvtLayer);
      console.log("‚úÖ MVT Layer eklendi!");

    } catch (error) {
      console.error("‚ùå Error:", error);
    }
  };

  render() {
    return (
      <div style={{ width: "100%", height: "100%" }}>
        <JimuMapViewComponent
          useMapWidgetId={this.props.useMapWidgetIds?.[0]}
          onActiveViewChange={this.onActiveViewChange}
        />
      </div>
    );
  }
}
