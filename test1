/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "https://your-api.com/api/vector/styles/all/style.json?coverageLayer=rsrp_dbm_poly";
const MANUAL_BEARER = "your_bearer_token_here";
const ARCGIS_API_VERSION = "4.32";
const MAPLIBRE_VERSION = "4.7.1";

interface State {
  message: string;
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;
  private mapLibreMap: any;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget y√ºkleniyor..."
    };
  }

  componentDidMount() {
    this.loadLibraries();
  }

  componentWillUnmount() {
    if (this.mapLibreMap) {
      this.mapLibreMap.remove();
    }
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  loadLibraries = () => {
    this.setState({ message: "üì¶ MapLibre y√ºkleniyor..." });

    // MapLibre CSS
    const maplibreCss = document.createElement("link");
    maplibreCss.rel = "stylesheet";
    maplibreCss.href = `https://unpkg.com/maplibre-gl@${MAPLIBRE_VERSION}/dist/maplibre-gl.css`;
    document.head.appendChild(maplibreCss);

    // MapLibre JS
    const maplibreScript = document.createElement("script");
    maplibreScript.src = `https://unpkg.com/maplibre-gl@${MAPLIBRE_VERSION}/dist/maplibre-gl.js`;
    maplibreScript.onload = () => {
      this.setState({ message: "‚úÖ MapLibre y√ºklendi" });
      this.createMapLibreMap();
    };
    document.head.appendChild(maplibreScript);
  };

  createMapLibreMap = async () => {
    this.setState({ message: "üó∫Ô∏è Map olu≈üturuluyor..." });

    try {
      // Style JSON'u fetch et
      const response = await fetch(MVT_STYLE_URL, {
        headers: {
          'Authorization': `Bearer ${MANUAL_BEARER}`
        }
      });

      const styleJson = await response.json();
      console.log("Style JSON:", styleJson);

      this.setState({ message: "üìÑ Style JSON alƒ±ndƒ±" });

      // Tile request'leri i√ßin transformRequest
      const maplibregl = (window as any).maplibregl;
      
      this.mapLibreMap = new maplibregl.Map({
        container: this.mapDiv,
        style: styleJson,
        center: [32, 39],
        zoom: 6,
        transformRequest: (url, resourceType) => {
          // API domain'ine giden isteklere Authorization ekle
          if (url.includes(new URL(MVT_STYLE_URL).hostname)) {
            return {
              url: url,
              headers: {
                'Authorization': `Bearer ${MANUAL_BEARER}`
              }
            };
          }
          return { url };
        }
      });

      this.mapLibreMap.on('load', () => {
        this.setState({ message: "‚úÖ MapLibre map y√ºklendi!" });
        console.log("Map layers:", this.mapLibreMap.getStyle().layers);
      });

      this.mapLibreMap.on('error', (e) => {
        this.setState({ message: `‚ùå Map error: ${e.error.message}` });
        console.error("MapLibre error:", e);
      });

    } catch (err) {
      this.setState({ message: `‚ùå ${err.message}` });
      console.error(err);
    }
  };

  render() {
    const { message } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.8)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px"
        }}>
          <strong>MVT Widget (MapLibre):</strong>
          <div style={{ marginTop: "10px" }}>{message}</div>
        </div>
      </div>
    );
  }
}
