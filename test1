/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "url//api/vector/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;
  private originalFetch = window.fetch;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget yÃ¼kleniyor...",
      currentZoom: 6
    };
  }

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
    // Restore original fetch
    window.fetch = this.originalFetch;
  }

  loadArcGISAPI = () => {
    this.setState({ message: "ðŸ“¦ ArcGIS API yÃ¼kleniyor..." });

    if ((window as any).require) {
      this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
      this.createMap();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const existing = document.querySelector(`script[data-arcgis-api="${ARCGIS_API_VERSION}"]`) as HTMLScriptElement | null;
    if (existing) {
      existing.addEventListener('load', () => {
        this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
        this.createMap();
      });
      return;
    }

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.setAttribute('data-arcgis-api', ARCGIS_API_VERSION);
    script.onload = () => {
      this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
      this.createMap();
    };
    script.onerror = () => {
      this.setState({ message: "âŒ ArcGIS API yÃ¼klenemedi" });
    };
    document.head.appendChild(script);
  };

  createMap = () => {
    this.setState({ message: "ðŸ—ºï¸ Map oluÅŸturuluyor..." });

    if (!this.mapDiv) {
      setTimeout(() => this.createMap(), 50);
      return;
    }

    if (!(window as any).require) {
      this.setState({ message: "âŒ ArcGIS API loader bulunamadÄ±" });
      return;
    }

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer',
      'esri/request'
    ], (Map, MapView, VectorTileLayer, esriRequest) => {
      
      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39],
        zoom: 6,
        constraints: {
          snapToZoom: false,  // SÃ¼rekli zoom iÃ§in - Ã‡OK Ã–NEMLÄ°!
          minZoom: 3,
          maxZoom: 20
        }
      });

      // Zoom deÄŸiÅŸikliklerini takip et
      this.mapView.watch('zoom', (newZoom) => {
        this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
      });

      this.setState({ message: "âœ… Map oluÅŸturuldu! MVT yÃ¼kleniyor..." });

      // Global fetch override - tile requests iÃ§in
      window.fetch = (url, options = {}) => {
        const urlStr = url.toString();
        if (urlStr.includes('api/vector/tile') || urlStr.includes(new URL(MVT_STYLE_URL).hostname)) {
          return this.originalFetch(url, {
            ...options,
            headers: {
              ...(options['headers'] || {}),
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          });
        }
        return this.originalFetch(url, options);
      };

      esriRequest(MVT_STYLE_URL, {
        headers: {
          'Authorization': `Bearer ${MANUAL_BEARER}`
        },
        responseType: 'json'
      }).then(response => {
        this.setState({ message: "ðŸ“„ Style JSON alÄ±ndÄ±, layer'lar oluÅŸturuluyor..." });
        const styleJson = response.data;

        // HER SOURCE Ä°Ã‡Ä°N AYRI VECTORTILELAYER OLUÅžTUR
        const zoomLevels = [
          { name: '3z', minZoom: 3, maxZoom: 7 },
          { name: '7z', minZoom: 7, maxZoom: 11 },
          { name: '11z', minZoom: 11, maxZoom: 15 },
          { name: '15z', minZoom: 15, maxZoom: 24 }
        ];

        let layersLoaded = 0;
        const totalLayers = zoomLevels.length;

        zoomLevels.forEach(({ name, minZoom, maxZoom }) => {
          const sourceName = `coverage_${name}`;
          const sourceConfig = styleJson.sources[sourceName];

          if (!sourceConfig) {
            console.warn(`Source ${sourceName} bulunamadÄ±`);
            return;
          }

          // Bu zoom level iÃ§in sadece fill layer'larÄ± kullan (line'larÄ± KES)
          const filteredLayers = styleJson.layers.filter(layer => 
            layer.source === sourceName && 
            layer.type === 'fill'  // SADECE FILL - line'larÄ± kaldÄ±r
          ).map(layer => ({
            ...layer,
            minzoom: minZoom,
            maxzoom: maxZoom,
            paint: {
              ...layer.paint,
              'fill-opacity': 0.65,  // Daha net gÃ¶rÃ¼nÃ¼m
              'fill-antialias': true  // Kenar yumuÅŸatma
            }
          }));

          // Bu source iÃ§in Ã¶zel style JSON
          const customStyle = {
            version: 8,
            sources: {
              [sourceName]: {
                ...sourceConfig,
                minzoom: minZoom,
                maxzoom: maxZoom
              }
            },
            layers: filteredLayers
          };

          console.log(`Creating layer for ${name}:`, customStyle);

          const mvtLayer = new VectorTileLayer({
            style: customStyle,
            minScale: this.zoomToScale(minZoom),
            maxScale: this.zoomToScale(maxZoom),
            opacity: 0.9,
            effect: "bloom(1.5, 0.5px, 0.1)"  // Daha net gÃ¶rÃ¼nÃ¼m
          });

          mvtLayer.when(() => {
            layersLoaded++;
            this.setState({ 
              message: `âœ… ${layersLoaded}/${totalLayers} MVT Layer yÃ¼klendi (${name})` 
            });
            
            if (layersLoaded === totalLayers) {
              setTimeout(() => {
                this.setState({ message: "âœ… TÃ¼m layer'lar hazÄ±r!" });
              }, 1000);
            }
          }).catch(err => {
            console.error(`Layer ${name} hatasÄ±:`, err);
            this.setState({ message: `âŒ Layer error (${name}): ${err.message}` });
          });

          map.add(mvtLayer);
        });

      }).catch(err => {
        this.setState({ message: `âŒ Style fetch error: ${err.message}` });
        console.error("FETCH HATASI:", err);
      });
    }, (err) => {
      this.setState({ message: `âŒ Loader error: ${err?.message || err}` });
      console.error('AMD require error:', err);
    });
  };

  // Zoom level'Ä± scale'e Ã§evir (ArcGIS iÃ§in)
  zoomToScale = (zoom: number): number => {
    // Web Mercator: scale = 591657527.591555 / (2^zoom)
    return 591657527.591555 / Math.pow(2, zoom);
  };

  render() {
    const { message, currentZoom } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.85)",
          color: "white",
          padding: "15px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px",
          minWidth: "250px",
          boxShadow: "0 4px 6px rgba(0,0,0,0.3)"
        }}>
          <strong style={{ color: "#4CAF50" }}>ðŸ“¡ MVT Coverage Widget</strong>
          <div style={{ marginTop: "10px", borderTop: "1px solid rgba(255,255,255,0.2)", paddingTop: "10px" }}>
            {message}
          </div>
          <div style={{ marginTop: "8px", fontSize: "11px", color: "#aaa" }}>
            Current Zoom: <span style={{ color: "#FFD700", fontWeight: "bold" }}>{currentZoom}</span>
          </div>
          <div style={{ marginTop: "6px", fontSize: "10px", color: "#888" }}>
            Active Tiles: {
              currentZoom < 7 ? "3z" :
              currentZoom < 11 ? "7z" :
              currentZoom < 15 ? "11z" : "15z"
            }
          </div>
        </div>
      </div>
    );
  }
}
