/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MANUAL_BEARER = "your_bearer_token_here";
const ARCGIS_API_VERSION = "4.32";

// Tile URL'leri
const TILE_URLS = {
  z3: "https://abc.com/oauth21/api/vector/tile/polygons/zxy/all/{z}/{x}/{y}.pbf?coverageLayer=rsrp_dbm",
  z7: "https://abc.com/oauth21/api/vector/tile/polygons/zxy/all/{z}/{x}/{y}.pbf?coverageLayer=rsrp_dbm",
  z11: "https://abc.com/oauth21/api/vector/tile/polygons/zxy/all/{z}/{x}/{y}.pbf?coverageLayer=rsrp_dbm",
  z15: "https://abc.com/oauth21/api/vector/tile/polygons/zxy/all/{z}/{x}/{y}.pbf?coverageLayer=rsrp_dbm"
};

interface State {
  message: string;
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget y√ºkleniyor..."
    };
  }

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  loadArcGISAPI = () => {
    this.setState({ message: "üì¶ ArcGIS API y√ºkleniyor..." });

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.onload = () => {
      this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
      this.createMap();
    };
    document.head.appendChild(script);
  };

  // RSRP deƒüerine g√∂re renk d√∂nd√ºr
  getRsrpColor = (rsrp: number) => {
    if (rsrp <= -135) return [49, 54, 149, 0.5];
    if (rsrp <= -126) return [69, 117, 180, 0.5];
    if (rsrp <= -118) return [116, 173, 209, 0.5];
    if (rsrp <= -109) return [171, 217, 233, 0.5];
    if (rsrp <= -100) return [224, 243, 248, 0.5];
    if (rsrp <= -92) return [255, 255, 191, 0.5];
    if (rsrp <= -83) return [254, 224, 144, 0.5];
    if (rsrp <= -75) return [253, 174, 97, 0.5];
    if (rsrp <= -66) return [244, 109, 67, 0.5];
    if (rsrp <= -57) return [215, 48, 39, 0.5];
    if (rsrp <= -49) return [165, 0, 38, 0.5];
    if (rsrp === 0) return [204, 204, 255, 0.5];
    if (rsrp === 1) return [204, 102, 255, 0.5];
    return [245, 245, 240, 0.5];
  };

  createMap = () => {
    this.setState({ message: "üó∫Ô∏è Map olu≈üturuluyor..." });

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer'
    ], (Map, MapView, VectorTileLayer) => {
      
      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39],
        zoom: 6
      });

      this.setState({ message: "‚úÖ Map olu≈üturuldu! MVT ekleniyor..." });

      // Fetch interceptor - tile request'lere auth ekle
      const originalFetch = window.fetch;
      window.fetch = (url, options = {}) => {
        const urlStr = url.toString();
        if (urlStr.includes('abc.com/oauth21/api/vector')) {
          return originalFetch(url, {
            ...options,
            headers: {
              ...(options['headers'] || {}),
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          });
        }
        return originalFetch(url, options);
      };

      // VectorTileLayer - URL'yi direkt kullan
      const mvtLayer = new VectorTileLayer({
        url: TILE_URLS.z15.replace('/{z}/{x}/{y}.pbf', ''), // Base URL
        // Manuel olarak style vermeyi dene
        portalItem: null
      });

      mvtLayer.when(() => {
        this.setState({ message: "üé® MVT y√ºklendi - style uygulanƒ±yor..." });
        
        // Layer'ƒ±n internal style'ƒ±nƒ± deƒüi≈ütirmeyi dene
        console.log("Layer info:", mvtLayer);
        console.log("Current style:", mvtLayer.currentStyleInfo);
        
      }).catch(err => {
        this.setState({ message: `‚ùå ${err.message}` });
        console.error("Layer error:", err);
      });

      map.add(mvtLayer);
    });
  };

  render() {
    const { message } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.8)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px"
        }}>
          <strong>MVT Widget:</strong>
          <div style={{ marginTop: "10px" }}>{message}</div>
        </div>
      </div>
    );
  }
}
