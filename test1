/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
}

// ESRI-optimized exponential interpolation
function interpolateRadius(zoom: number, stops: number[][], base: number = 2): number {
  if (stops.length < 2) return stops[0]?.[1] || 1;
  
  // Find the two stops we're between
  let lowerStop = stops[0];
  let upperStop = stops[stops.length - 1];
  
  for (let i = 0; i < stops.length - 1; i++) {
    if (zoom >= stops[i][0] && zoom <= stops[i + 1][0]) {
      lowerStop = stops[i];
      upperStop = stops[i + 1];
      break;
    }
  }
  
  const [z1, r1] = lowerStop;
  const [z2, r2] = upperStop;
  
  // Clamp to bounds
  if (zoom <= z1) return r1;
  if (zoom >= z2) return r2;
  
  // Exponential interpolation matching Maplibre's algorithm
  const t = (zoom - z1) / (z2 - z1);
  const progress = Math.pow(base, t) - 1;
  const range = Math.pow(base, 1) - 1;
  const normalizedProgress = progress / range;
  
  return r1 + (r2 - r1) * normalizedProgress;
}

// Convert Maplibre pixel radius to ESRI points (accounting for screen density)
function pixelsToPoints(pixels: number): number {
  // ESRI uses points, Maplibre uses pixels
  // Typically 1 point = 1.33 pixels on standard displays
  return pixels * 0.75; // Adjustment factor for better visual match
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;
  private layers: any[] = [];
  private originalFetch = window.fetch;
  private zoomUpdateTimeout: any = null;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget y√ºkleniyor...",
      currentZoom: 15
    };
  }

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  loadArcGISAPI = () => {
    this.setState({ message: "üì¶ ArcGIS API y√ºkleniyor..." });

    if ((window as any).require) {
      this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
      this.createMap();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const existing = document.querySelector(`script[data-arcgis-api="${ARCGIS_API_VERSION}"]`) as HTMLScriptElement | null;
    if (existing) {
      existing.addEventListener('load', () => {
        this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
        this.createMap();
      });
      return;
    }

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.setAttribute('data-arcgis-api', ARCGIS_API_VERSION);
    script.onload = () => {
      this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
      this.createMap();
    };
    script.onerror = () => {
      this.setState({ message: "‚ùå ArcGIS API y√ºklenemedi" });
    };
    document.head.appendChild(script);
  };

  updateLayerSizes = (zoom: number) => {
    // Her layer i√ßin circle radius'u g√ºncelle
    const radiusConfigs = {
      'Coverage 15z': { stops: [[15, 2.5], [22, 250]], base: 2, minZoom: 15, maxZoom: 24 },
      'Coverage 11z': { stops: [[11, 2], [15, 20]], base: 2, minZoom: 11, maxZoom: 15 },
      'Coverage 7z': { stops: [[7, 1], [11, 13]], base: 2, minZoom: 7, maxZoom: 11 },
      'Coverage 3z': { stops: [[3, 1], [7, 10]], base: 2, minZoom: 3, maxZoom: 7 }
    };

    this.layers.forEach(layer => {
      const config = radiusConfigs[layer.title];
      if (!config) return;
      
      // Sadece bu layer'ƒ±n zoom aralƒ±ƒüƒ±ndaysak g√ºncelle
      if (zoom < config.minZoom || zoom > config.maxZoom) {
        return;
      }
      
      const rawRadius = interpolateRadius(zoom, config.stops, config.base);
      const adjustedRadius = pixelsToPoints(rawRadius);
      
      console.log(`üìê ${layer.title} @ z${zoom.toFixed(1)}: ${rawRadius.toFixed(2)}px ‚Üí ${adjustedRadius.toFixed(2)}pt`);
      
      // Style'ƒ± g√ºncelle
      const currentStyle = layer.style;
      if (currentStyle && currentStyle.layers) {
        const updatedLayers = currentStyle.layers.map(styleLayer => {
          if (styleLayer.type === 'circle' && styleLayer.paint) {
            return {
              ...styleLayer,
              paint: {
                ...styleLayer.paint,
                'circle-radius': adjustedRadius,
                'circle-pitch-alignment': 'map', // ESRI i√ßin √∂nemli
                'circle-pitch-scale': 'map' // ESRI i√ßin √∂nemli
              }
            };
          }
          return styleLayer;
        });

        // Deep clone to trigger ESRI update
        layer.style = JSON.parse(JSON.stringify({
          ...currentStyle,
          layers: updatedLayers
        }));
        
        // Force layer refresh
        layer.refresh();
      }
    });
  };

  createMap = () => {
    this.setState({ message: "üó∫Ô∏è Map olu≈üturuluyor..." });

    if (!this.mapDiv) {
      setTimeout(() => this.createMap(), 50);
      return;
    }

    if (!(window as any).require) {
      this.setState({ message: "‚ùå ArcGIS API loader bulunamadƒ±" });
      return;
    }

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer',
      'esri/request'
    ], (Map, MapView, VectorTileLayer, esriRequest) => {
      
      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39],
        zoom: 15,
        constraints: {
          snapToZoom: false,
          minZoom: 3,
          maxzoom: 22,
          rotationEnabled: false
        },
        navigation: {
          mouseWheelZoomEnabled: true,
          browserTouchPanEnabled: true
        }
      });

      // Mouse wheel zoom control
      this.mapView.when(() => {
        const container = this.mapView.container as HTMLElement;
        
        container.addEventListener('wheel', (event: WheelEvent) => {
          event.preventDefault();
          
          const currentZoom = this.mapView.zoom;
          const delta = event.deltaY;
          const zoomChange = delta > 0 ? -0.2 : 0.2;
          const newZoom = Math.max(3, Math.min(22, currentZoom + zoomChange));
          
          this.mapView.goTo({
            zoom: newZoom
          }, {
            duration: 100
          });
        }, { passive: false });
      });

      // ‚úÖ ZOOM DEƒûƒ∞≈ûƒ∞NCE CIRCLE RADIUS'U G√úNCELLE (debounced)
      this.mapView.watch('zoom', (newZoom) => {
        this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
        
        // Debounce: √áok hƒ±zlƒ± zoom deƒüi≈üimlerinde her seferinde g√ºncelleme yapma
        if (this.zoomUpdateTimeout) {
          clearTimeout(this.zoomUpdateTimeout);
        }
        
        this.zoomUpdateTimeout = setTimeout(() => {
          this.updateLayerSizes(newZoom);
        }, 50); // 50ms delay
      });

      this.setState({ message: "‚úÖ Map olu≈üturuldu! MVT y√ºkleniyor..." });

      // Fetch override for authorization
      const originalFetch = window.fetch;
      window.fetch = (url, options = {}) => {
        const urlStr = url.toString();
        if (urlStr.includes(new URL(MVT_STYLE_URL).hostname)) {
          const zxyMatch = urlStr.match(/\/(\d+)\/(\d+)\/(\d+)\.pbf/);
          if (zxyMatch) {
            const [, z] = zxyMatch;
            console.log(`üîç Tile request: zoom ${z}`);
          }
          
          return originalFetch(url, {
            ...options,
            headers: {
              ...(options['headers'] || {}),
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          });
        }
        return originalFetch(url, options);
      };

      esriRequest(MVT_STYLE_URL, {
        headers: {
          'Authorization': `Bearer ${MANUAL_BEARER}`
        },
        responseType: 'json'
      }).then(response => {
        this.setState({ message: "üìÑ Style JSON alƒ±ndƒ±, layer'lar olu≈üturuluyor..." });
        const originalStyle = response.data;

        // Her zoom level i√ßin ayrƒ± style JSON olu≈ütur
        const zoomConfigs = [
          { name: '3z', source: 'coverage_3z', minZoom: 0, maxZoom: 7, stops: [[3, 1], [7, 10]], base: 2 },
          { name: '7z', source: 'coverage_7z', minZoom: 7, maxZoom: 11, stops: [[7, 1], [11, 13]], base: 2 },
          { name: '11z', source: 'coverage_11z', minZoom: 11, maxZoom: 15, stops: [[11, 2], [15, 20]], base: 2 },
          { name: '15z', source: 'coverage_15z', minZoom: 15, maxZoom: 24, stops: [[15, 2.5], [22, 250]], base: 2 }
        ];

        zoomConfigs.forEach(config => {
          const currentZoom = this.mapView.zoom;
          const rawRadius = interpolateRadius(currentZoom, config.stops, config.base);
          const initialRadius = pixelsToPoints(rawRadius);

          // Bu zoom level i√ßin √∂zel style JSON
          const customStyle = {
            version: 8,
            sources: {
              [config.source]: originalStyle.sources[config.source]
            },
            layers: originalStyle.layers.filter(layer => 
              layer.source === config.source
            ).map(layer => {
              const updatedPaint = {
                ...layer.paint,
                'circle-radius': initialRadius,
                'circle-pitch-alignment': 'map',
                'circle-pitch-scale': 'map'
              };
              
              return {
                ...layer,
                minzoom: config.minZoom,
                maxzoom: config.maxZoom,
                paint: updatedPaint
              };
            })
          };

          console.log(`üé® Creating layer ${config.name}: z${currentZoom.toFixed(1)} ‚Üí ${rawRadius.toFixed(2)}px (${initialRadius.toFixed(2)}pt)`);

          const layer = new VectorTileLayer({
            style: customStyle,
            minScale: 0,
            maxScale: 0,
            title: `Coverage ${config.name}`,
            opacity: 0.85 // Biraz transparanlƒ±k ekle, overlap daha iyi g√∂r√ºns√ºn
          });

          layer.when(() => {
            console.log(`‚úÖ Layer ${config.name} loaded`);
          }).catch(err => {
            console.error(`‚ùå Layer ${config.name} error:`, err);
          });

          map.add(layer);
          this.layers.push(layer);
        });

        this.setState({ message: "‚úÖ T√ºm layer'lar olu≈üturuldu!" });
        
        // ƒ∞lk zoom i√ßin radius'u ayarla
        this.updateLayerSizes(this.mapView.zoom);
        
      }).catch(err => {
        this.setState({ message: `‚ùå Fetch error: ${err.message}` });
        console.error("FETCH HATASI:", err);
      });
    }, (err) => {
      this.setState({ message: `‚ùå Loader error: ${err?.message || err}` });
      console.error('AMD require error:', err);
    });
  };

  render() {
    const { message, currentZoom } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        {/* Zoom Control Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          right: "10px",
          background: "rgba(0,0,0,0.9)",
          color: "white",
          padding: "20px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "14px",
          minWidth: "200px"
        }}>
          <div style={{ marginBottom: "15px", textAlign: "center", fontWeight: "bold", color: "#4CAF50" }}>
            üéÆ ZOOM TEST
          </div>
          
          <div style={{ 
            background: "rgba(255,255,255,0.1)", 
            padding: "15px", 
            borderRadius: "5px",
            marginBottom: "15px",
            textAlign: "center"
          }}>
            <div style={{ fontSize: "12px", color: "#aaa", marginBottom: "5px" }}>
              Zoom Level
            </div>
            <div style={{ fontSize: "32px", fontWeight: "bold", color: "#FFD700" }}>
              {currentZoom}
            </div>
          </div>

          <div style={{ display: "flex", gap: "10px", marginBottom: "15px" }}>
            <button
              onClick={() => {
                if (this.mapView) {
                  const newZoom = this.mapView.zoom - 0.1;
                  this.mapView.goTo({ zoom: newZoom }, { duration: 200 });
                }
              }}
              style={{
                flex: 1,
                padding: "15px",
                fontSize: "20px",
                background: "#f44336",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontWeight: "bold"
              }}
            >
              -
            </button>
            <button
              onClick={() => {
                if (this.mapView) {
                  const newZoom = this.mapView.zoom + 0.1;
                  this.mapView.goTo({ zoom: newZoom }, { duration: 200 });
                }
              }}
              style={{
                flex: 1,
                padding: "15px",
                fontSize: "20px",
                background: "#4CAF50",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontWeight: "bold"
              }}
            >
              +
            </button>
          </div>
        </div>

        {/* Status Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.8)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px"
        }}>
          <strong>MVT Multi-Layer:</strong>
          <div style={{ marginTop: "10px" }}>{message}</div>
          <div style={{ marginTop: "5px", fontSize: "11px" }}>
            Expected: {
              currentZoom < 7 ? "10km (3z)" :
              currentZoom < 11 ? "1km (7z)" :
              currentZoom < 15 ? "100m (11z)" : "10m (15z)"
            }
          </div>
        </div>
      </div>
    );
  }
}
