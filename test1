/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "url//api/vector/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;
  private originalFetch = window.fetch;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget yÃ¼kleniyor...",
      currentZoom: 6
    };
  }

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
    window.fetch = this.originalFetch;
  }

  loadArcGISAPI = () => {
    this.setState({ message: "ðŸ“¦ ArcGIS API yÃ¼kleniyor..." });

    if ((window as any).require) {
      this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
      this.createMap();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const existing = document.querySelector(`script[data-arcgis-api="${ARCGIS_API_VERSION}"]`) as HTMLScriptElement | null;
    if (existing) {
      existing.addEventListener('load', () => {
        this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
        this.createMap();
      });
      return;
    }

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.setAttribute('data-arcgis-api', ARCGIS_API_VERSION);
    script.onload = () => {
      this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
      this.createMap();
    };
    script.onerror = () => {
      this.setState({ message: "âŒ ArcGIS API yÃ¼klenemedi" });
    };
    document.head.appendChild(script);
  };

  createMap = () => {
    this.setState({ message: "ðŸ—ºï¸ Map oluÅŸturuluyor..." });

    if (!this.mapDiv) {
      setTimeout(() => this.createMap(), 50);
      return;
    }

    if (!(window as any).require) {
      this.setState({ message: "âŒ ArcGIS API loader bulunamadÄ±" });
      return;
    }

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer',
      'esri/request'
    ], (Map, MapView, VectorTileLayer, esriRequest) => {
      
      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39],
        zoom: 7,  // âœ… 6'dan 7'ye Ã§Ä±kardÄ±k - API'nin 7z tile'Ä± var!
        constraints: {
          snapToZoom: false,  // âœ… Smooth zoom
          minZoom: 3,
          maxZoom: 20
        }
      });

      // Zoom tracking
      this.mapView.watch('zoom', (newZoom) => {
        this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
        console.log(`ðŸ” Current zoom: ${newZoom}, Closest API zoom: ${this.getClosestApiZoom(newZoom)}`);
      });

      this.setState({ message: "âœ… Map oluÅŸturuldu! MVT yÃ¼kleniyor..." });

      // esriRequest ile Authorization header ekle
      // âœ…âœ…âœ… Ã–NEMLÄ°: FETCH OVERRIDE'I LAYER OLUÅžTURMADAN Ã–NCE YAP!
      const originalFetch = window.fetch;
      window.fetch = (url, options = {}) => {
        const urlStr = url.toString();
        if (urlStr.includes('abc.com') || urlStr.includes('/api/vector/tile')) {
          console.log("ðŸ” Tile request intercepted:", urlStr);
          console.log("ðŸ“‹ Original headers:", options['headers']);
          
          const newOptions = {
            ...options,
            headers: {
              ...(options['headers'] || {}),
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          };
          
          console.log("ðŸ“‹ Modified headers:", newOptions.headers);
          
          return originalFetch(url, newOptions).then(resp => {
            console.log(`ðŸ“¡ Response for ${urlStr}:`, resp.status, resp.statusText);
            if (!resp.ok) {
              console.error(`âŒ HTTP Error ${resp.status} for:`, urlStr);
            }
            return resp;
          }).catch(err => {
            console.error(`âŒ Fetch error for ${urlStr}:`, err);
            throw err;
          });
        }
        return originalFetch(url, options);
      };

      esriRequest(MVT_STYLE_URL, {
        headers: {
          'Authorization': `Bearer ${MANUAL_BEARER}`
        },
        responseType: 'json'
      }).then(response => {
        this.setState({ message: "ðŸ“„ Style JSON alÄ±ndÄ±" });
        let styleJson = response.data;
        
        console.log("ðŸ“¥ Original Style JSON:", JSON.stringify(styleJson, null, 2));
        
        // âœ… TILE URL'LERÄ°NÄ° KONTROL ET
        Object.keys(styleJson.sources).forEach(sourceKey => {
          const source = styleJson.sources[sourceKey];
          console.log(`ðŸ” Source: ${sourceKey}`);
          console.log(`   Tiles:`, source.tiles);
          console.log(`   Min/Max Zoom:`, source.minzoom, '/', source.maxzoom);
        });

        // âœ…âœ…âœ… KRÄ°TÄ°K: SOURCE ZOOM RANGE'LERÄ°NÄ° GENÄ°ÅžLET
        // API sadece belirli zoom'larda tile Ã¼retiyor ama ArcGIS'e daha geniÅŸ range sÃ¶ylemeliyiz
        if (styleJson.sources.coverage_3z) {
          styleJson.sources.coverage_3z.minzoom = 0;
          styleJson.sources.coverage_3z.maxzoom = 7;
        }
        if (styleJson.sources.coverage_7z) {
          styleJson.sources.coverage_7z.minzoom = 7;
          styleJson.sources.coverage_7z.maxzoom = 11;
        }
        if (styleJson.sources.coverage_11z) {
          styleJson.sources.coverage_11z.minzoom = 11;
          styleJson.sources.coverage_11z.maxzoom = 15;
        }
        if (styleJson.sources.coverage_15z) {
          styleJson.sources.coverage_15z.minzoom = 15;
          styleJson.sources.coverage_15z.maxzoom = 24;
        }

        console.log("ðŸ“ Modified source zoom ranges");

        // âœ… OPTÄ°MÄ°ZASYON 1: Line layer'larÄ± kaldÄ±r (siyah Ã§izgileri Ã¶nler)
        styleJson = {
          ...styleJson,
          layers: styleJson.layers.filter(layer => layer.type === 'fill')
        };

        // âœ… OPTÄ°MÄ°ZASYON 2: Fill opacity artÄ±r (daha belirgin)
        styleJson.layers = styleJson.layers.map(layer => ({
          ...layer,
          paint: {
            ...layer.paint,
            'fill-opacity': 0.7,  // 0.5'ten 0.7'ye Ã§Ä±kardÄ±k
            'fill-antialias': true
          }
        }));

        console.log("ðŸ“¤ Modified Style JSON:", styleJson);

        // VectorTileLayer oluÅŸtur
        const mvtLayer = new VectorTileLayer({
          style: styleJson,
          opacity: 1,
          visible: true  // âœ… Explicit visible
        });

        mvtLayer.when(() => {
          this.setState({ message: "âœ… MVT Layer yÃ¼klendi!" });
          console.log("âœ… Layer loaded successfully");
          console.log("   Layer visible:", mvtLayer.visible);
          console.log("   Layer opacity:", mvtLayer.opacity);
          console.log("   Layer in map:", map.layers.includes(mvtLayer));
        }).catch(err => {
          this.setState({ message: `âŒ Layer error: ${err.message}` });
          console.error("âŒ Layer hatasÄ±:", err);
        });

        map.add(mvtLayer);
        
      }).catch(err => {
        this.setState({ message: `âŒ Fetch error: ${err.message}` });
        console.error("âŒ FETCH HATASI detay:", err);
        console.error("URL:", MVT_STYLE_URL);
        console.error("Token:", MANUAL_BEARER ? "Var" : "YOK!");
      });
    }, (err) => {
      this.setState({ message: `âŒ Loader error: ${err?.message || err}` });
      console.error('âŒ AMD require error:', err);
    });
  };

  // Zoom level'Ä± scale'e Ã§evir (ArcGIS iÃ§in)
  getClosestApiZoom = (zoom: number): number => {
    const apiZooms = [3, 7, 11, 15];
    return apiZooms.reduce((prev, curr) => 
      Math.abs(curr - zoom) < Math.abs(prev - zoom) ? curr : prev
    );
  };

  render() {
    const { message, currentZoom } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.85)",
          color: "white",
          padding: "15px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px",
          minWidth: "280px",
          boxShadow: "0 4px 6px rgba(0,0,0,0.3)"
        }}>
          <div style={{ display: "flex", alignItems: "center", gap: "8px" }}>
            <strong style={{ color: "#4CAF50" }}>ðŸ“¡ MVT Coverage</strong>
            <span style={{ 
              fontSize: "10px", 
              background: "#2196F3", 
              padding: "2px 6px", 
              borderRadius: "3px" 
            }}>
              Optimized
            </span>
          </div>
          
          <div style={{ 
            marginTop: "10px", 
            borderTop: "1px solid rgba(255,255,255,0.2)", 
            paddingTop: "10px" 
          }}>
            {message}
          </div>
          
          <div style={{ 
            marginTop: "10px",
            padding: "8px",
            background: "rgba(255,255,255,0.05)",
            borderRadius: "4px",
            fontSize: "11px"
          }}>
            <div style={{ marginBottom: "4px" }}>
              Zoom: <span style={{ color: "#FFD700", fontWeight: "bold" }}>{currentZoom}</span>
            </div>
            <div style={{ fontSize: "10px", color: "#888" }}>
              Active: {
                currentZoom < 7 ? "3z tiles (zoom 3-7)" :
                currentZoom < 11 ? "7z tiles (zoom 7-11)" :
                currentZoom < 15 ? "11z tiles (zoom 11-15)" : "15z tiles (zoom 15+)"
              }
            </div>
          </div>

          <div style={{
            marginTop: "8px",
            fontSize: "9px",
            color: "#666",
            borderTop: "1px solid rgba(255,255,255,0.1)",
            paddingTop: "6px"
          }}>
            âœ¨ No line borders â€¢ Higher opacity â€¢ Smooth zoom
          </div>
        </div>
      </div>
    );
  }
}
