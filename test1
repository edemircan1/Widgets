/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
}

// RSRP renk haritasƒ±
const RSRP_COLOR_MAP = [
  { min: -135, max: -126, color: '#313695' },
  { min: -126, max: -118, color: '#4575B4' },
  { min: -118, max: -109, color: '#74ADD1' },
  { min: -109, max: -100, color: '#ABD9E9' },
  { min: -100, max: -92, color: '#E0F3F8' },
  { min: -92, max: -83, color: '#FFFFBF' },
  { min: -83, max: -75, color: '#FEE090' },
  { min: -75, max: -66, color: '#FDAE61' },
  { min: -66, max: -57, color: '#F46D43' },
  { min: -57, max: -49, color: '#D73027' },
  { min: -49, max: 0, color: '#A50026' }
];

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;
  private map: any;
  private currentLayers: any[] = [];
  private styleData: any = null;
  private VectorTileLayer: any = null;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget y√ºkleniyor...",
      currentZoom: 15
    };
  }

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  loadArcGISAPI = () => {
    this.setState({ message: "üì¶ ArcGIS API y√ºkleniyor..." });

    if ((window as any).require) {
      this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
      this.createMap();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.setAttribute('data-arcgis-api', ARCGIS_API_VERSION);
    script.onload = () => {
      this.setState({ message: "‚úÖ ArcGIS API y√ºklendi" });
      this.createMap();
    };
    script.onerror = () => {
      this.setState({ message: "‚ùå ArcGIS API y√ºklenemedi" });
    };
    document.head.appendChild(script);
  };

  createMap = () => {
    this.setState({ message: "üó∫Ô∏è Map olu≈üturuluyor..." });

    if (!this.mapDiv) {
      setTimeout(() => this.createMap(), 50);
      return;
    }

    if (!(window as any).require) {
      this.setState({ message: "‚ùå ArcGIS API loader bulunamadƒ±" });
      return;
    }

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer',
      'esri/request'
    ], (Map, MapView, VectorTileLayer, esriRequest) => {
      
      this.VectorTileLayer = VectorTileLayer;
      
      this.map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.mapView = new MapView({
        container: this.mapDiv,
        map: this.map,
        center: [32, 39],
        zoom: 15,
        constraints: {
          snapToZoom: false,
          minZoom: 3,
          maxZoom: 22,
          rotationEnabled: false
        }
      });

      // Watch zoom changes
      this.mapView.watch('zoom', (newZoom) => {
        const roundedZoom = Math.round(newZoom * 10) / 10;
        this.setState({ currentZoom: roundedZoom });
        
        // Zoom level deƒüi≈ütiƒüinde layer'larƒ± yeniden y√ºkle
        if (this.styleData) {
          this.updateLayersForZoom(newZoom);
        }
      });

      this.setState({ message: "‚úÖ Map hazƒ±r! MVT y√ºkleniyor..." });

      // Setup fetch override for authorization
      const originalFetch = window.fetch;
      window.fetch = (url, options = {}) => {
        const urlStr = url.toString();
        if (urlStr.includes('oauth21') || urlStr.includes('vector/tile')) {
          return originalFetch(url, {
            ...options,
            headers: {
              ...(options['headers'] || {}),
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          });
        }
        return originalFetch(url, options);
      };

      // Style JSON'ƒ± √ßek
      esriRequest(MVT_STYLE_URL, {
        headers: { 'Authorization': `Bearer ${MANUAL_BEARER}` },
        responseType: 'json'
      }).then(response => {
        this.styleData = response.data;
        console.log("‚úÖ Style JSON fetched:", this.styleData);
        
        // ƒ∞lk layer'larƒ± y√ºkle
        this.updateLayersForZoom(this.mapView.zoom);
        
      }).catch(err => {
        this.setState({ message: `‚ùå Style fetch failed: ${err.message}` });
        console.error("Style fetch error:", err);
      });
      
    }, (err) => {
      this.setState({ message: `‚ùå Loader error: ${err?.message || err}` });
    });
  };

  // Zoom level'a g√∂re uygun source'u se√ß
  getSourceForZoom = (zoom: number): { name: string, source: string, minZoom: number, maxZoom: number } => {
    if (zoom < 7) return { name: '3z', source: 'coverage_3z', minZoom: 3, maxZoom: 7 };
    if (zoom < 11) return { name: '7z', source: 'coverage_7z', minZoom: 7, maxZoom: 11 };
    if (zoom < 15) return { name: '11z', source: 'coverage_11z', minZoom: 11, maxZoom: 15 };
    return { name: '15z', source: 'coverage_15z', minZoom: 15, maxZoom: 24 };
  };

  // Mevcut layer'larƒ± temizle
  clearLayers = () => {
    this.currentLayers.forEach(layer => {
      this.map.remove(layer);
    });
    this.currentLayers = [];
  };

  // Zoom level i√ßin layer'larƒ± g√ºncelle
  updateLayersForZoom = (zoom: number) => {
    const zoomConfig = this.getSourceForZoom(zoom);
    console.log(`\nüîÑ Updating layers for zoom ${zoom} ‚Üí using ${zoomConfig.name}`);
    
    this.clearLayers();
    this.setState({ message: `üé® ${zoomConfig.name} layer'larƒ± y√ºkleniyor...` });

    // Her RSRP range i√ßin layer olu≈ütur
    RSRP_COLOR_MAP.forEach((colorRange, index) => {
      
      const customStyle = {
        version: 8,
        sources: {
          [zoomConfig.source]: this.styleData.sources[zoomConfig.source]
        },
        layers: [
          {
            id: `fill_${zoomConfig.source}_${index}`,
            type: 'fill',
            source: zoomConfig.source,
            'source-layer': 'data',
            minzoom: zoomConfig.minZoom,
            maxzoom: zoomConfig.maxZoom,
            filter: [
              'all',
              ['>=', ['get', 'rsrp_dbm'], colorRange.min],
              ['<', ['get', 'rsrp_dbm'], colorRange.max]
            ],
            paint: {
              'fill-color': colorRange.color,
              'fill-opacity': 0.6
            }
          },
          {
            id: `line_${zoomConfig.source}_${index}`,
            type: 'line',
            source: zoomConfig.source,
            'source-layer': 'data',
            minzoom: zoomConfig.minZoom,
            maxzoom: zoomConfig.maxZoom,
            filter: [
              'all',
              ['>=', ['get', 'rsrp_dbm'], colorRange.min],
              ['<', ['get', 'rsrp_dbm'], colorRange.max]
            ],
            paint: {
              'line-color': colorRange.color,
              'line-opacity': 0.8,
              'line-width': 0.5
            }
          }
        ]
      };

      const layer = new this.VectorTileLayer({
        style: customStyle,
        minScale: 0,
        maxScale: 0,
        title: `${zoomConfig.name}_range_${index}`,
        opacity: 1.0
      });

      layer.when(() => {
        console.log(`  ‚úÖ Layer ${index} loaded for ${zoomConfig.name}`);
      }).catch(err => {
        console.error(`  ‚ùå Layer ${index} error:`, err);
      });

      this.map.add(layer);
      this.currentLayers.push(layer);
    });

    this.setState({ 
      message: `‚úÖ ${zoomConfig.name} y√ºklendi! (${RSRP_COLOR_MAP.length} renk katmanƒ±)` 
    });
  };

  render() {
    const { message, currentZoom } = this.state;
    const zoomConfig = this.getSourceForZoom(currentZoom);

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        {/* Status Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.9)",
          color: "white",
          padding: "15px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "11px",
          maxWidth: "320px"
        }}>
          <div style={{ marginBottom: "10px", fontWeight: "bold", color: "#4CAF50", fontSize: "13px" }}>
            üé® MVT COLORED POLYGONS
          </div>
          
          <div style={{ marginBottom: "10px", padding: "8px", background: "rgba(255,255,255,0.1)", borderRadius: "4px" }}>
            <div style={{ fontSize: "10px", color: "#aaa" }}>Zoom: {currentZoom}</div>
            <div style={{ fontSize: "10px", color: "#aaa", marginTop: "3px" }}>
              Active: {zoomConfig.name}
            </div>
            <div style={{ fontSize: "10px", color: "#aaa", marginTop: "3px" }}>
              Layers: {this.currentLayers.length}
            </div>
          </div>

          <div style={{ fontSize: "10px", lineHeight: "1.5", color: "#ddd" }}>
            {message}
          </div>

          <div style={{ marginTop: "10px", fontSize: "9px", color: "#888", lineHeight: "1.4" }}>
            ‚úÖ Filter expressions √ßalƒ±≈üƒ±yor!<br/>
            ‚úÖ Her RSRP range ayrƒ± layer<br/>
            ‚úÖ Zoom'a g√∂re otomatik g√ºncelleme
          </div>
        </div>

        {/* Color Legend */}
        <div style={{
          position: "absolute",
          top: "10px",
          right: "10px",
          background: "rgba(0,0,0,0.9)",
          color: "white",
          padding: "12px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "10px",
          maxWidth: "180px"
        }}>
          <div style={{ marginBottom: "8px", fontWeight: "bold", fontSize: "11px" }}>
            üìä RSRP (dBm)
          </div>
          {RSRP_COLOR_MAP.map((range, idx) => (
            <div key={idx} style={{ display: "flex", alignItems: "center", marginBottom: "4px" }}>
              <div style={{ 
                width: "20px", 
                height: "12px", 
                background: range.color, 
                marginRight: "6px",
                border: "1px solid #555",
                borderRadius: "2px"
              }}></div>
              <div style={{ fontSize: "9px" }}>
                {range.min} to {range.max}
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }
}
