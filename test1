/** @jsx jsx */
import { React, jsx } from "jimu-core";
import { JimuMapViewComponent, JimuMapView } from "jimu-arcgis";

const MVT_STYLE_URL = "https://your-api.com/api/vector/styles/all/style.json?coverageLayer=rsrp_dbm_poly";
const MANUAL_BEARER = "your_bearer_token_here";

export default class Widget extends React.PureComponent<any, any> {
  private originalFetch = window.fetch;

  componentDidMount() {
    const self = this;
    window.fetch = function(url, options = {}) {
      const urlStr = url.toString();
      if (urlStr.includes('your-api.com')) {
        return self.originalFetch(url, {
          ...options,
          headers: {
            ...(options['headers'] || {}),
            'Authorization': `Bearer ${MANUAL_BEARER}`
          }
        });
      }
      return self.originalFetch(url, options);
    };
  }

  componentWillUnmount() {
    window.fetch = this.originalFetch;
  }

  onActiveViewChange = (jmv: JimuMapView) => {
    if (!jmv) return;

    const modules = (jmv.view as any).declaredClass ? ['esri/layers/VectorTileLayer'] : null;
    
    if (!modules) {
      console.error("‚ùå ArcGIS API bulunamadƒ±");
      return;
    }

    // JimuMapView'in kendi require'ƒ±nƒ± kullan
    (window as any).require(modules, (VectorTileLayer) => {
      console.log("‚úÖ VectorTileLayer y√ºklendi");
      
      fetch(MVT_STYLE_URL)
        .then(res => res.json())
        .then(styleJson => {
          console.log("üìÑ Style JSON alƒ±ndƒ±");
          const layer = new VectorTileLayer({ style: styleJson });
          jmv.view.map.add(layer);
          console.log("‚úÖ MVT Layer eklendi!");
        })
        .catch(err => console.error("‚ùå Hata:", err));
    });
  };

  render() {
    return (
      <div style={{ width: "100%", height: "100%" }}>
        <JimuMapViewComponent
          useMapWidgetId={this.props.useMapWidgetIds?.[0]}
          onActiveViewChange={this.onActiveViewChange}
        />
      </div>
    );
  }
}
