/** @jsx jsx */
import { React, jsx } from "jimu-core";

const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
  step: number;
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget ba≈ülatƒ±lƒ±yor...",
      currentZoom: 15,
      step: 1
    };
  }

  componentDidMount() {
    this.loadArcGIS();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  loadArcGIS = () => {
    this.setState({ message: "STEP 1: ArcGIS API y√ºkleniyor..." });

    if ((window as any).require) {
      this.setState({ message: "STEP 1: ArcGIS API zaten y√ºkl√º" });
      this.createArcGISMap();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.onload = () => {
      this.setState({ message: "STEP 1: ‚úÖ ArcGIS API y√ºklendi" });
      this.createArcGISMap();
    };
    script.onerror = () => {
      this.setState({ message: "STEP 1: ‚ùå ArcGIS y√ºklenemedi" });
    };
    document.head.appendChild(script);
  };

  createArcGISMap = () => {
    this.setState({ message: "STEP 2: ArcGIS Map olu≈üturuluyor..." });

    if (!this.mapDiv) {
      console.log("‚ö†Ô∏è mapDiv hen√ºz hazƒ±r deƒüil, bekleniyor...");
      setTimeout(() => this.createArcGISMap(), 100);
      return;
    }

    console.log("‚úÖ mapDiv hazƒ±r:", this.mapDiv);

    (window as any).require([
      'esri/Map',
      'esri/views/MapView'
    ], (Map, MapView) => {
      
      console.log("üì¶ ArcGIS modules loaded");

      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      console.log("üó∫Ô∏è Map olu≈üturuldu");

      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39],
        zoom: 15
      });

      console.log("üó∫Ô∏è MapView olu≈üturuldu");

      this.mapView.when(() => {
        console.log("‚úÖ MapView.when() triggered");
        this.setState({ 
          message: "STEP 2: ‚úÖ ArcGIS Map g√∂r√ºn√ºr!", 
          step: 2 
        });
      }).catch(err => {
        console.error("‚ùå MapView error:", err);
        this.setState({ message: `STEP 2: ‚ùå MapView error: ${err.message}` });
      });

      this.mapView.watch('zoom', (newZoom) => {
        this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
      });

    }, (err) => {
      console.error("‚ùå AMD require error:", err);
      this.setState({ message: `STEP 2: ‚ùå Module load error: ${err}` });
    });
  };

  render() {
    const { message, currentZoom, step } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        {/* Map Container */}
        <div 
          ref={el => {
            console.log("üîó mapDiv ref set:", el ? "YES" : "NO");
            this.mapDiv = el;
          }}
          style={{ 
            width: "100%", 
            height: "100%",
            background: "#1a1a1a" // Debug: g√∂r√ºls√ºn diye
          }}
        />

        {/* Debug Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          right: "10px",
          background: "rgba(0,0,0,0.95)",
          color: "white",
          padding: "20px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "13px",
          minWidth: "300px"
        }}>
          <div style={{ marginBottom: "15px", textAlign: "center", fontWeight: "bold", color: "#FF6B6B" }}>
            üîç DEBUG MODE
          </div>
          
          <div style={{ 
            background: "rgba(255,255,255,0.1)", 
            padding: "15px", 
            borderRadius: "5px",
            marginBottom: "15px"
          }}>
            <div style={{ fontSize: "11px", color: "#aaa", marginBottom: "5px" }}>
              Current Step
            </div>
            <div style={{ fontSize: "28px", fontWeight: "bold", color: step === 2 ? "#4CAF50" : "#FFD700" }}>
              {step} / 2
            </div>
          </div>

          <div style={{ fontSize: "11px", marginBottom: "15px", lineHeight: "1.6" }}>
            <strong style={{ color: "#FFD700" }}>Status:</strong>
            <div style={{ marginTop: "8px", color: "#fff" }}>
              {message}
            </div>
          </div>

          {step === 2 && (
            <div style={{ 
              background: "rgba(76, 175, 80, 0.2)", 
              padding: "10px", 
              borderRadius: "5px",
              border: "1px solid #4CAF50"
            }}>
              <div style={{ fontSize: "11px", color: "#4CAF50", fontWeight: "bold" }}>
                ‚úÖ SUCCESS!
              </div>
              <div style={{ fontSize: "10px", color: "#aaa", marginTop: "5px" }}>
                Zoom: {currentZoom}
              </div>
            </div>
          )}

          <div style={{ fontSize: "10px", color: "#888", marginTop: "15px", lineHeight: "1.5" }}>
            Open Console (F12) to see logs
          </div>
        </div>

        {/* Basit Zoom Controls */}
        {step === 2 && (
          <div style={{
            position: "absolute",
            bottom: "20px",
            right: "20px",
            display: "flex",
            gap: "10px",
            zIndex: 9999
          }}>
            <button
              onClick={() => {
                if (this.mapView) {
                  this.mapView.goTo({ zoom: this.mapView.zoom - 1 });
                }
              }}
              style={{
                padding: "10px 20px",
                fontSize: "18px",
                background: "#f44336",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontWeight: "bold"
              }}
            >
              -
            </button>
            <button
              onClick={() => {
                if (this.mapView) {
                  this.mapView.goTo({ zoom: this.mapView.zoom + 1 });
                }
              }}
              style={{
                padding: "10px 20px",
                fontSize: "18px",
                background: "#4CAF50",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontWeight: "bold"
              }}
            >
              +
            </button>
          </div>
        )}
      </div>
    );
  }
}
