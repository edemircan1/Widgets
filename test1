/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget yÃ¼kleniyor...",
      currentZoom: 15
    };
  }

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  loadArcGISAPI = () => {
    this.setState({ message: "ğŸ“¦ ArcGIS API yÃ¼kleniyor..." });

    if ((window as any).require) {
      this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
      this.createMap();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const existing = document.querySelector(`script[data-arcgis-api="${ARCGIS_API_VERSION}"]`) as HTMLScriptElement | null;
    if (existing) {
      existing.addEventListener('load', () => {
        this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
        this.createMap();
      });
      return;
    }

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.setAttribute('data-arcgis-api', ARCGIS_API_VERSION);
    script.onload = () => {
      this.setState({ message: "âœ… ArcGIS API yÃ¼klendi" });
      this.createMap();
    };
    script.onerror = () => {
      this.setState({ message: "âŒ ArcGIS API yÃ¼klenemedi" });
    };
    document.head.appendChild(script);
  };

  // ğŸ¨ interpolate â†’ step expression'a Ã§evir
  convertInterpolateToStep = (interpolateArray) => {
    // interpolate formatÄ±: ["interpolate", ["linear"], ["get", "rsrp_dbm"], -135, "#313695", -126, "#4575B4", ...]
    // step formatÄ±: ["step", ["get", "rsrp_dbm"], defaultColor, threshold1, color1, threshold2, color2, ...]
    
    if (!Array.isArray(interpolateArray) || interpolateArray[0] !== 'interpolate') {
      return interpolateArray; // Zaten interpolate deÄŸilse olduÄŸu gibi dÃ¶n
    }

    const stops = [];
    for (let i = 3; i < interpolateArray.length; i += 2) {
      if (i + 1 < interpolateArray.length) {
        stops.push({
          value: interpolateArray[i],
          color: interpolateArray[i + 1]
        });
      }
    }

    if (stops.length === 0) {
      return interpolateArray;
    }

    // step expression oluÅŸtur
    const stepExpression = [
      "step",
      ["get", "rsrp_dbm"],
      stops[0].color // default color (ilk renk)
    ];

    // DiÄŸer threshold'larÄ± ekle
    for (let i = 1; i < stops.length; i++) {
      stepExpression.push(stops[i].value);
      stepExpression.push(stops[i].color);
    }

    return stepExpression;
  };

  createMap = () => {
    this.setState({ message: "ğŸ—ºï¸ Map oluÅŸturuluyor..." });

    if (!this.mapDiv) {
      setTimeout(() => this.createMap(), 50);
      return;
    }

    if (!(window as any).require) {
      this.setState({ message: "âŒ ArcGIS API loader bulunamadÄ±" });
      return;
    }

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer',
      'esri/request'
    ], (Map, MapView, VectorTileLayer, esriRequest) => {
      
      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39],
        zoom: 15,
        constraints: {
          snapToZoom: false,
          minZoom: 3,
          maxZoom: 22,
          rotationEnabled: false
        },
        navigation: {
          mouseWheelZoomEnabled: true,
          browserTouchPanEnabled: true
        }
      });

      // Mouse wheel zoom control
      this.mapView.when(() => {
        const container = this.mapView.container as HTMLElement;
        
        container.addEventListener('wheel', (event: WheelEvent) => {
          event.preventDefault();
          
          const currentZoom = this.mapView.zoom;
          const delta = event.deltaY;
          const zoomChange = delta > 0 ? -0.2 : 0.2;
          const newZoom = Math.max(3, Math.min(22, currentZoom + zoomChange));
          
          this.mapView.goTo({
            zoom: newZoom
          }, {
            duration: 100
          });
        }, { passive: false });
      });

      this.mapView.watch('zoom', (newZoom) => {
        this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
      });

      this.setState({ message: "âœ… Map oluÅŸturuldu! MVT yÃ¼kleniyor..." });

      // Fetch override for authorization
      const originalFetch = window.fetch;
      window.fetch = (url, options = {}) => {
        const urlStr = url.toString();
        if (urlStr.includes('abc.com') || urlStr.includes(new URL(MVT_STYLE_URL, window.location.href).hostname)) {
          const zxyMatch = urlStr.match(/\/(\d+)\/(\d+)\/(\d+)\.pbf/);
          if (zxyMatch) {
            const [, z, x, y] = zxyMatch;
            console.log(`ğŸ” Tile request: Z=${z}, X=${x}, Y=${y}`);
          }
          
          return originalFetch(url, {
            ...options,
            headers: {
              ...(options['headers'] || {}),
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          });
        }
        return originalFetch(url, options);
      };

      // ğŸ¯ Ã‡Ã–ZÃœM: Style JSON'u al ve interpolate â†’ step'e Ã§evir
      esriRequest(MVT_STYLE_URL, {
        headers: {
          'Authorization': `Bearer ${MANUAL_BEARER}`
        },
        responseType: 'json'
      }).then(response => {
        this.setState({ message: "ğŸ“„ Style JSON alÄ±ndÄ±, dÃ¼zenleniyor..." });
        const originalStyle = response.data;
        
        console.log("ğŸ“¥ Original Style JSON:", originalStyle);

        // ğŸ¨ Her layer'Ä±n paint bilgisini interpolate â†’ step'e Ã§evir
        const fixedStyle = {
          version: 8,
          sources: originalStyle.sources,
          layers: originalStyle.layers.map(layer => {
            const newLayer = { ...layer };

            if (layer.paint) {
              const newPaint = { ...layer.paint };

              // fill-color'u dÃ¼zelt
              if (newPaint['fill-color']) {
                const converted = this.convertInterpolateToStep(newPaint['fill-color']);
                console.log(`ğŸ¨ Converting ${layer.id} fill-color:`);
                console.log("  Original:", newPaint['fill-color']);
                console.log("  Converted:", converted);
                newPaint['fill-color'] = converted;
              }

              // line-color'u dÃ¼zelt
              if (newPaint['line-color']) {
                const converted = this.convertInterpolateToStep(newPaint['line-color']);
                console.log(`ğŸ¨ Converting ${layer.id} line-color:`);
                console.log("  Original:", newPaint['line-color']);
                console.log("  Converted:", converted);
                newPaint['line-color'] = converted;
              }

              newLayer.paint = newPaint;
            }

            return newLayer;
          })
        };

        console.log("âœ… Fixed Style JSON:", fixedStyle);

        // VectorTileLayer oluÅŸtur
        const vectorTileLayer = new VectorTileLayer({
          style: fixedStyle,
          title: "Coverage MVT (Step Colors)"
        });

        // Layer debug
        vectorTileLayer.when(() => {
          console.log("âœ… VectorTileLayer loaded!");
          console.log("ğŸ“Š Layer properties:");
          console.log("  - loaded:", vectorTileLayer.loaded);
          console.log("  - visible:", vectorTileLayer.visible);
          console.log("  - style:", vectorTileLayer.style);
          console.log("  - currentStyleInfo:", vectorTileLayer.currentStyleInfo);
          
          this.setState({ message: "âœ… Renkli MVT layer yÃ¼klendi! (Step expression)" });
        }).catch(err => {
          console.error("âŒ VectorTileLayer error:", err);
          this.setState({ message: `âŒ Layer error: ${err.message}` });
        });

        map.add(vectorTileLayer);
        
      }).catch(err => {
        this.setState({ message: `âŒ Fetch error: ${err.message}` });
        console.error("FETCH HATASI:", err);
      });
    }, (err) => {
      this.setState({ message: `âŒ Loader error: ${err?.message || err}` });
      console.error('AMD require error:', err);
    });
  };

  render() {
    const { message, currentZoom } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%" }}
        />

        {/* Zoom Control Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          right: "10px",
          background: "rgba(0,0,0,0.9)",
          color: "white",
          padding: "20px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "14px",
          minWidth: "200px"
        }}>
          <div style={{ marginBottom: "15px", textAlign: "center", fontWeight: "bold", color: "#4CAF50" }}>
            ğŸ® STEP EXPRESSION
          </div>
          
          <div style={{ 
            background: "rgba(255,255,255,0.1)", 
            padding: "15px", 
            borderRadius: "5px",
            marginBottom: "15px",
            textAlign: "center"
          }}>
            <div style={{ fontSize: "12px", color: "#aaa", marginBottom: "5px" }}>
              Zoom Level
            </div>
            <div style={{ fontSize: "32px", fontWeight: "bold", color: "#FFD700" }}>
              {currentZoom}
            </div>
          </div>

          <div style={{ display: "flex", gap: "10px", marginBottom: "15px" }}>
            <button
              onClick={() => {
                if (this.mapView) {
                  const newZoom = this.mapView.zoom - 0.1;
                  this.mapView.goTo({ zoom: newZoom }, { duration: 200 });
                }
              }}
              style={{
                flex: 1,
                padding: "15px",
                fontSize: "20px",
                background: "#f44336",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontWeight: "bold"
              }}
            >
              -
            </button>
            <button
              onClick={() => {
                if (this.mapView) {
                  const newZoom = this.mapView.zoom + 0.1;
                  this.mapView.goTo({ zoom: newZoom }, { duration: 200 });
                }
              }}
              style={{
                flex: 1,
                padding: "15px",
                fontSize: "20px",
                background: "#4CAF50",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontWeight: "bold"
              }}
            >
              +
            </button>
          </div>

          <div style={{ fontSize: "10px", color: "#888", textAlign: "center" }}>
            Check console for conversion logs
          </div>
        </div>

        {/* Status Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.8)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px"
        }}>
          <strong>ğŸ¨ Color Mode: STEP</strong>
          <div style={{ marginTop: "10px" }}>{message}</div>
          <div style={{ marginTop: "5px", fontSize: "11px", color: "#4CAF50" }}>
            Grid: {
              currentZoom < 7 ? "10km (3z)" :
              currentZoom < 11 ? "1km (7z)" :
              currentZoom < 15 ? "100m (11z)" : "10m (15z)"
            }
          </div>
          <div style={{ marginTop: "10px", fontSize: "10px", color: "#888" }}>
            interpolate â†’ step conversion
          </div>
        </div>
      </div>
    );
  }
}
