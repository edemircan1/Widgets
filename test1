/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";
const MAPLIBRE_VERSION = "4.7.1";

interface State {
  message: string;
  currentZoom: number;
  isSyncing: boolean;
}

export default class Widget extends React.PureComponent<any, State> {
  private arcgisDiv: HTMLDivElement;
  private maplibreDiv: HTMLDivElement;
  private arcgisView: any;
  private maplibreMap: any;
  private syncEnabled: boolean = true;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget y√ºkleniyor...",
      currentZoom: 15,
      isSyncing: false
    };
  }

  componentDidMount() {
    this.loadLibraries();
  }

  componentWillUnmount() {
    if (this.arcgisView) {
      this.arcgisView.destroy();
    }
    if (this.maplibreMap) {
      this.maplibreMap.remove();
    }
  }

  loadLibraries = () => {
    // MapLibre CSS
    if (!document.querySelector('link[href*="maplibre-gl.css"]')) {
      const cssLink = document.createElement("link");
      cssLink.rel = "stylesheet";
      cssLink.href = `https://unpkg.com/maplibre-gl@${MAPLIBRE_VERSION}/dist/maplibre-gl.css`;
      document.head.appendChild(cssLink);
    }

    // MapLibre JS
    if (!(window as any).maplibregl) {
      const script = document.createElement("script");
      script.src = `https://unpkg.com/maplibre-gl@${MAPLIBRE_VERSION}/dist/maplibre-gl.js`;
      script.onload = () => {
        console.log("‚úÖ MapLibre loaded");
        this.loadArcGIS();
      };
      document.head.appendChild(script);
    } else {
      this.loadArcGIS();
    }
  };

  loadArcGIS = () => {
    this.setState({ message: "üì¶ ArcGIS API y√ºkleniyor..." });

    if ((window as any).require) {
      this.createMaps();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.onload = () => {
      console.log("‚úÖ ArcGIS loaded");
      this.createMaps();
    };
    document.head.appendChild(script);
  };

  createMaps = () => {
    if (!this.arcgisDiv || !this.maplibreDiv) {
      setTimeout(() => this.createMaps(), 100);
      return;
    }

    this.setState({ message: "üó∫Ô∏è Creating hybrid map..." });

    (window as any).require([
      'esri/Map',
      'esri/views/MapView'
    ], (Map, MapView) => {
      
      // 1Ô∏è‚É£ ArcGIS Map (Bottom layer - basemap)
      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.arcgisView = new MapView({
        container: this.arcgisDiv,
        map: map,
        center: [32, 39],
        zoom: 15,
        constraints: {
          snapToZoom: false,
          minZoom: 3,
          maxZoom: 22,
          rotationEnabled: false
        }
      });

      this.arcgisView.when(() => {
        console.log("‚úÖ ArcGIS MapView ready");
        this.setState({ message: "‚úÖ ArcGIS ready, loading MapLibre..." });
        
        // ArcGIS zoom deƒüi≈üimlerini izle
        this.arcgisView.watch('zoom', (newZoom) => {
          this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
          
          // MapLibre'yi senkronize et
          if (this.maplibreMap && this.syncEnabled && !this.state.isSyncing) {
            this.setState({ isSyncing: true });
            this.maplibreMap.setZoom(newZoom);
            setTimeout(() => this.setState({ isSyncing: false }), 100);
          }
        });

        // ArcGIS center deƒüi≈üimlerini izle
        this.arcgisView.watch('center', (newCenter) => {
          if (this.maplibreMap && this.syncEnabled && !this.state.isSyncing) {
            this.setState({ isSyncing: true });
            this.maplibreMap.setCenter([newCenter.longitude, newCenter.latitude]);
            setTimeout(() => this.setState({ isSyncing: false }), 100);
          }
        });

        // 2Ô∏è‚É£ MapLibre Map (Top layer - MVT overlay)
        this.createMapLibreOverlay();
      });
    });
  };

  createMapLibreOverlay = () => {
    this.setState({ message: "üé® Creating MapLibre overlay..." });

    // Fetch style JSON
    fetch(MVT_STYLE_URL, {
      headers: {
        'Authorization': `Bearer ${MANUAL_BEARER}`
      }
    })
    .then(res => res.json())
    .then(styleJson => {
      console.log("üìã Style JSON received:", styleJson);

      const maplibregl = (window as any).maplibregl;

      // MapLibre map - ≈ûEFFAF basemap, sadece MVT
      this.maplibreMap = new maplibregl.Map({
        container: this.maplibreDiv,
        style: styleJson, // API'dan gelen style - native MapLibre!
        center: [32, 39],
        zoom: 15,
        interactive: false, // ArcGIS handle etsin
        attributionControl: false,
        preserveDrawingBuffer: true
      });

      // Tile isteklerine auth ekle
      this.maplibreMap.on('styleimagemissing', () => {
        // Ignore missing sprite images
      });

      // MapLibre tile isteklerini intercept et
      const originalTransformRequest = this.maplibreMap._requestManager._transformRequestFn;
      this.maplibreMap._requestManager._transformRequestFn = (url, resourceType) => {
        if (url.includes('abc.com')) {
          return {
            url: url,
            headers: {
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          };
        }
        return originalTransformRequest ? originalTransformRequest(url, resourceType) : { url };
      };

      this.maplibreMap.on('load', () => {
        console.log("‚úÖ MapLibre loaded with native MVT support!");
        this.setState({ message: "‚úÖ Hybrid map ready! üé®" });

        // Debug: Layers listesi
        const layers = this.maplibreMap.getStyle().layers;
        console.log("üìä MapLibre layers:", layers.map(l => l.id));
        
        // Debug: Sources listesi
        const sources = this.maplibreMap.getStyle().sources;
        console.log("üìä MapLibre sources:", Object.keys(sources));
      });

      this.maplibreMap.on('error', (e) => {
        console.error("‚ùå MapLibre error:", e);
      });

      this.maplibreMap.on('data', (e) => {
        if (e.dataType === 'source' && e.sourceId && e.isSourceLoaded) {
          console.log(`üì¶ Source loaded: ${e.sourceId}`);
        }
      });

    })
    .catch(err => {
      console.error("‚ùå Style fetch error:", err);
      this.setState({ message: `‚ùå Style error: ${err.message}` });
    });
  };

  render() {
    const { message, currentZoom } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        {/* ArcGIS Map (Bottom) */}
        <div 
          ref={el => this.arcgisDiv = el}
          style={{ 
            width: "100%", 
            height: "100%", 
            position: "absolute", 
            top: 0, 
            left: 0,
            zIndex: 1
          }}
        />

        {/* MapLibre Overlay (Top) */}
        <div 
          ref={el => this.maplibreDiv = el}
          style={{ 
            width: "100%", 
            height: "100%", 
            position: "absolute", 
            top: 0, 
            left: 0,
            pointerEvents: "none", // Tƒ±klamalarƒ± ArcGIS'e ge√ßir
            zIndex: 2
          }}
        />

        {/* Control Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          right: "10px",
          background: "rgba(0,0,0,0.95)",
          color: "white",
          padding: "20px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "14px",
          minWidth: "250px"
        }}>
          <div style={{ 
            marginBottom: "15px", 
            textAlign: "center", 
            fontWeight: "bold", 
            fontSize: "16px",
            background: "linear-gradient(90deg, #4CAF50, #2196F3)",
            WebkitBackgroundClip: "text",
            WebkitTextFillColor: "transparent"
          }}>
            üé® HYBRID MODE
          </div>
          
          <div style={{ 
            background: "rgba(255,255,255,0.1)", 
            padding: "15px", 
            borderRadius: "5px",
            marginBottom: "15px",
            textAlign: "center"
          }}>
            <div style={{ fontSize: "12px", color: "#aaa", marginBottom: "5px" }}>
              Zoom Level
            </div>
            <div style={{ fontSize: "32px", fontWeight: "bold", color: "#FFD700" }}>
              {currentZoom}
            </div>
          </div>

          <div style={{ 
            fontSize: "11px", 
            padding: "10px", 
            background: "rgba(76,175,80,0.2)", 
            borderRadius: "5px",
            marginBottom: "10px",
            borderLeft: "3px solid #4CAF50"
          }}>
            <div style={{ fontWeight: "bold", marginBottom: "5px", color: "#4CAF50" }}>
              ‚úÖ Active Layers:
            </div>
            <div style={{ fontSize: "10px", lineHeight: "1.6" }}>
              üó∫Ô∏è ArcGIS Basemap<br/>
              üé® MapLibre MVT (colored)
            </div>
          </div>

          <div style={{ 
            fontSize: "10px", 
            color: "#888",
            textAlign: "center",
            padding: "8px",
            background: "rgba(255,255,255,0.05)",
            borderRadius: "4px"
          }}>
            üí° Pan/Zoom on ArcGIS<br/>
            MapLibre syncs automatically
          </div>
        </div>

        {/* Status Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.9)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px",
          maxWidth: "300px"
        }}>
          <div style={{ 
            fontWeight: "bold", 
            marginBottom: "10px",
            color: "#2196F3"
          }}>
            üöÄ Hybrid Architecture:
          </div>
          <div style={{ fontSize: "11px", lineHeight: "1.8", color: "#ccc" }}>
            {message}
          </div>
          <div style={{ 
            marginTop: "10px", 
            paddingTop: "10px", 
            borderTop: "1px solid rgba(255,255,255,0.2)",
            fontSize: "10px",
            color: "#888"
          }}>
            <div>Bottom: Esri SDK {ARCGIS_API_VERSION}</div>
            <div>Top: MapLibre GL {MAPLIBRE_VERSION}</div>
          </div>
        </div>
      </div>
    );
  }
}
