/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";

interface State {
  message: string;
  currentZoom: number;
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private maplibreMap: any;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget y√ºkleniyor...",
      currentZoom: 15
    };
  }

  componentDidMount() {
    this.loadMapLibre();
  }

  componentWillUnmount() {
    if (this.maplibreMap) {
      this.maplibreMap.remove();
    }
  }

  loadMapLibre = () => {
    this.setState({ message: "üì¶ MapLibre y√ºkleniyor..." });

    // MapLibre CSS
    if (!document.querySelector('link[href*="maplibre-gl.css"]')) {
      const cssLink = document.createElement("link");
      cssLink.rel = "stylesheet";
      cssLink.href = "https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css";
      document.head.appendChild(cssLink);
    }

    // MapLibre JS
    if ((window as any).maplibregl) {
      this.setState({ message: "‚úÖ MapLibre zaten y√ºkl√º" });
      this.createMap();
      return;
    }

    const existing = document.querySelector('script[src*="maplibre-gl.js"]');
    if (existing) {
      existing.addEventListener('load', () => {
        this.setState({ message: "‚úÖ MapLibre y√ºklendi" });
        this.createMap();
      });
      return;
    }

    const script = document.createElement("script");
    script.src = "https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js";
    script.onload = () => {
      this.setState({ message: "‚úÖ MapLibre y√ºklendi" });
      this.createMap();
    };
    script.onerror = () => {
      this.setState({ message: "‚ùå MapLibre y√ºklenemedi" });
    };
    document.head.appendChild(script);
  };

  createMap = () => {
    if (!this.mapDiv) {
      setTimeout(() => this.createMap(), 100);
      return;
    }

    if (!(window as any).maplibregl) {
      setTimeout(() => this.createMap(), 100);
      return;
    }

    this.setState({ message: "üó∫Ô∏è Map olu≈üturuluyor..." });

    const maplibregl = (window as any).maplibregl;

    // Fetch override √ñNCE
    const originalFetch = window.fetch;
    window.fetch = (url, options = {}) => {
      const urlStr = url.toString();
      if (urlStr.includes('abc.com') || urlStr.includes('/styles/')) {
        console.log(`üîç Fetch with auth: ${urlStr}`);
        return originalFetch(url, {
          ...options,
          headers: {
            ...(options['headers'] || {}),
            'Authorization': `Bearer ${MANUAL_BEARER}`
          }
        });
      }
      return originalFetch(url, options);
    };

    // Style JSON'u fetch et
    this.setState({ message: "üìÑ Style JSON alƒ±nƒ±yor..." });
    
    fetch(MVT_STYLE_URL, {
      headers: {
        'Authorization': `Bearer ${MANUAL_BEARER}`
      }
    })
    .then(res => {
      console.log("üì• Style response status:", res.status);
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      return res.json();
    })
    .then(styleJson => {
      console.log("‚úÖ Style JSON received:", styleJson);
      this.setState({ message: "üìã Style JSON alƒ±ndƒ±, map olu≈üturuluyor..." });

      // MapLibre map olu≈ütur
      this.maplibreMap = new maplibregl.Map({
        container: this.mapDiv,
        style: styleJson,
        center: [32, 39],
        zoom: 15,
        attributionControl: false
      });

      this.maplibreMap.on('load', () => {
        console.log("‚úÖ MapLibre map loaded!");
        
        // Layers'ƒ± listele
        const style = this.maplibreMap.getStyle();
        console.log("üìä Map style:", style);
        console.log("üìä Layers:", style.layers.map(l => `${l.id} (${l.type})`));
        console.log("üìä Sources:", Object.keys(style.sources));
        
        this.setState({ message: "‚úÖ MapLibre map y√ºklendi!" });
      });

      this.maplibreMap.on('error', (e) => {
        console.error("‚ùå MapLibre error:", e);
        this.setState({ message: `‚ùå MapLibre error: ${e.error?.message || 'unknown'}` });
      });

      this.maplibreMap.on('data', (e) => {
        if (e.dataType === 'source' && e.isSourceLoaded) {
          console.log(`üì¶ Source loaded: ${e.sourceId}`);
        }
      });

      this.maplibreMap.on('zoom', () => {
        const zoom = this.maplibreMap.getZoom();
        this.setState({ currentZoom: Math.round(zoom * 10) / 10 });
      });

      this.maplibreMap.on('sourcedata', (e) => {
        if (e.isSourceLoaded && e.tile) {
          console.log(`üîç Tile loaded: ${e.sourceId} - ${e.tile.tileID.canonical.z}/${e.tile.tileID.canonical.x}/${e.tile.tileID.canonical.y}`);
        }
      });

    })
    .catch(err => {
      console.error("‚ùå Fetch error:", err);
      this.setState({ message: `‚ùå Fetch error: ${err.message}` });
    });
  };

  render() {
    const { message, currentZoom } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        {/* MapLibre Container */}
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%", background: "#1a1a1a" }}
        />

        {/* Zoom Control Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          right: "10px",
          background: "rgba(0,0,0,0.9)",
          color: "white",
          padding: "20px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "14px",
          minWidth: "200px"
        }}>
          <div style={{ marginBottom: "15px", textAlign: "center", fontWeight: "bold", color: "#FF6B6B" }}>
            üß™ PURE MAPLIBRE TEST
          </div>
          
          <div style={{ 
            background: "rgba(255,255,255,0.1)", 
            padding: "15px", 
            borderRadius: "5px",
            marginBottom: "15px",
            textAlign: "center"
          }}>
            <div style={{ fontSize: "12px", color: "#aaa", marginBottom: "5px" }}>
              Zoom Level
            </div>
            <div style={{ fontSize: "32px", fontWeight: "bold", color: "#FFD700" }}>
              {currentZoom}
            </div>
          </div>

          <div style={{ display: "flex", gap: "10px", marginBottom: "15px" }}>
            <button
              onClick={() => {
                if (this.maplibreMap) {
                  const newZoom = this.maplibreMap.getZoom() - 0.5;
                  this.maplibreMap.setZoom(newZoom);
                }
              }}
              style={{
                flex: 1,
                padding: "15px",
                fontSize: "20px",
                background: "#f44336",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontWeight: "bold"
              }}
            >
              -
            </button>
            <button
              onClick={() => {
                if (this.maplibreMap) {
                  const newZoom = this.maplibreMap.getZoom() + 0.5;
                  this.maplibreMap.setZoom(newZoom);
                }
              }}
              style={{
                flex: 1,
                padding: "15px",
                fontSize: "20px",
                background: "#4CAF50",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontWeight: "bold"
              }}
            >
              +
            </button>
          </div>

          <div style={{ fontSize: "10px", color: "#FFD700", textAlign: "center" }}>
            Open Console (F12)
          </div>
        </div>

        {/* Status Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.85)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px",
          maxWidth: "300px"
        }}>
          <strong style={{ color: "#FF6B6B" }}>üß™ DEBUG MODE:</strong>
          <div style={{ marginTop: "10px", color: "#FFD700" }}>{message}</div>
          <div style={{ marginTop: "10px", fontSize: "10px", color: "#888", borderTop: "1px solid rgba(255,255,255,0.1)", paddingTop: "10px" }}>
            <div>‚Ä¢ Check console for logs</div>
            <div>‚Ä¢ Look for tile requests</div>
            <div>‚Ä¢ Check for errors</div>
          </div>
          <div style={{ marginTop: "10px", fontSize: "11px", color: "#4CAF50" }}>
            Expected Grid: {
              currentZoom < 7 ? "10km (3z)" :
              currentZoom < 11 ? "1km (7z)" :
              currentZoom < 15 ? "100m (11z)" : "10m (15z)"
            }
          </div>
        </div>
      </div>
    );
  }
}
