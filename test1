/** @jsx jsx */
import { React, jsx } from "jimu-core";
import { JimuMapView } from "jimu-arcgis";

const MVT_STYLE_URL = "https://your-api.com/api/vector/styles/all/style.json?coverageLayer=rsrp_dbm_poly";
const MANUAL_BEARER = "your_bearer_token_here";

interface State {
  message: string;
  mapLoaded: boolean;
}

export default class Widget extends React.PureComponent<any, State> {
  private originalFetch = window.fetch;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget y√ºkleniyor...",
      mapLoaded: false
    };
  }

  componentDidMount() {
    const self = this;
    window.fetch = function(url, options = {}) {
      const urlStr = url.toString();
      if (urlStr.includes('your-api.com')) {
        return self.originalFetch(url, {
          ...options,
          headers: {
            ...(options['headers'] || {}),
            'Authorization': `Bearer ${MANUAL_BEARER}`
          }
        });
      }
      return self.originalFetch(url, options);
    };

    // Map manager'ƒ± dinamik import et
    this.findMap();
  }

  componentWillUnmount() {
    window.fetch = this.originalFetch;
  }

  findMap = async () => {
    try {
      this.setState({ message: "üîç Map Manager y√ºkleniyor..." });
      
      const { MapViewManager } = await import("jimu-arcgis");
      const manager = MapViewManager.getInstance();
      const allViews = manager.getAllJimuMapViewIds();
      
      console.log("Bulunan map'ler:", allViews);
      
      if (allViews && allViews.length > 0) {
        this.setState({ message: `üìç Map bulundu: ${allViews[0]}` });
        const jmv = await manager.getJimuMapViewById(allViews[0]);
        this.onMapReady(jmv);
      } else {
        this.setState({ message: "‚ùå Map widget bulunamadƒ±! Experience'a Map ekle." });
      }
    } catch (err) {
      this.setState({ message: `‚ùå Map Manager hatasƒ±: ${err.message}` });
      console.error(err);
    }
  };

  onMapReady = (jmv: JimuMapView) => {
    if (!jmv) {
      this.setState({ message: "‚ùå Map view null!" });
      return;
    }

    this.setState({ 
      message: "‚úÖ Map y√ºklendi! MVT ekleniyor...",
      mapLoaded: true 
    });

    (window as any).require(['esri/layers/VectorTileLayer'], (VectorTileLayer) => {
      this.setState({ message: "üì¶ VectorTileLayer y√ºklendi" });
      
      fetch(MVT_STYLE_URL)
        .then(res => {
          this.setState({ message: `üì° Fetch: ${res.status}` });
          return res.json();
        })
        .then(styleJson => {
          this.setState({ message: "üìÑ Style JSON alƒ±ndƒ±" });
          console.log("STYLE:", styleJson);
          
          const layer = new VectorTileLayer({ style: styleJson });
          jmv.view.map.add(layer);
          
          this.setState({ message: "‚úÖ MVT Layer eklendi!" });
        })
        .catch(err => {
          this.setState({ message: `‚ùå ${err.message}` });
          console.error(err);
        });
    });
  };

  render() {
    const { message, mapLoaded } = this.state;
    
    return (
      <div style={{
        position: "fixed",
        top: "10px",
        left: "10px",
        background: "rgba(0,0,0,0.8)",
        color: "white",
        padding: "15px",
        borderRadius: "5px",
        zIndex: 9999,
        maxWidth: "400px",
        fontFamily: "monospace",
        fontSize: "12px"
      }}>
        <div><strong>MVT Widget Debug:</strong></div>
        <div style={{ marginTop: "10px" }}>{message}</div>
        <div style={{ marginTop: "5px", color: mapLoaded ? "#0f0" : "#f00" }}>
          Map: {mapLoaded ? "LOADED" : "NOT LOADED"}
        </div>
      </div>
    );
  }
}
