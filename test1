/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
  maplibreLoaded: boolean;
  arcgisLoaded: boolean;
}

export default class Widget extends React.PureComponent<any, State> {
  private arcgisDiv: HTMLDivElement;
  private maplibreDiv: HTMLDivElement;
  private mapView: any;
  private maplibreMap: any;
  private syncing: boolean = false;

  constructor(props) {
    super(props);
    this.state = {
      message: "Widget yÃ¼kleniyor...",
      currentZoom: 15,
      maplibreLoaded: false,
      arcgisLoaded: false
    };
  }

  componentDidMount() {
    this.loadMapLibre();
    this.loadArcGIS();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
    if (this.maplibreMap) {
      this.maplibreMap.remove();
    }
  }

  loadMapLibre = () => {
    this.setState({ message: "ğŸ“¦ MapLibre yÃ¼kleniyor..." });

    // CSS
    if (!document.querySelector('link[href*="maplibre-gl.css"]')) {
      const cssLink = document.createElement("link");
      cssLink.rel = "stylesheet";
      cssLink.href = "https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css";
      document.head.appendChild(cssLink);
    }

    // JS
    if ((window as any).maplibregl) {
      this.setState({ maplibreLoaded: true, message: "âœ… MapLibre hazÄ±r" });
      this.tryCreateHybrid();
      return;
    }

    const script = document.createElement("script");
    script.src = "https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js";
    script.onload = () => {
      this.setState({ maplibreLoaded: true, message: "âœ… MapLibre yÃ¼klendi" });
      this.tryCreateHybrid();
    };
    script.onerror = () => {
      this.setState({ message: "âŒ MapLibre yÃ¼klenemedi" });
    };
    document.head.appendChild(script);
  };

  loadArcGIS = () => {
    if ((window as any).require) {
      this.setState({ arcgisLoaded: true });
      this.tryCreateHybrid();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.onload = () => {
      this.setState({ arcgisLoaded: true });
      this.tryCreateHybrid();
    };
    document.head.appendChild(script);
  };

  tryCreateHybrid = () => {
    if (this.state.maplibreLoaded && this.state.arcgisLoaded) {
      this.createHybridMap();
    }
  };

  createHybridMap = () => {
    if (!this.arcgisDiv || !this.maplibreDiv) {
      setTimeout(() => this.createHybridMap(), 100);
      return;
    }

    this.setState({ message: "ğŸ—ºï¸ ArcGIS Map oluÅŸturuluyor..." });

    // 1. ArcGIS Map (altta)
    (window as any).require(['esri/Map', 'esri/views/MapView'], (Map, MapView) => {
      
      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.mapView = new MapView({
        container: this.arcgisDiv,
        map: map,
        center: [32, 39],
        zoom: 15
      });

      this.mapView.when(() => {
        this.setState({ message: "âœ… ArcGIS hazÄ±r! MapLibre overlay oluÅŸturuluyor..." });
        this.createMapLibreOverlay();
      });

      this.mapView.watch('zoom', (newZoom) => {
        this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
      });
    });
  };

  createMapLibreOverlay = () => {
    this.setState({ message: "ğŸ¨ MapLibre MVT yÃ¼kleniyor..." });

    const maplibregl = (window as any).maplibregl;

    // Fetch style JSON
    fetch(MVT_STYLE_URL, {
      headers: { 'Authorization': `Bearer ${MANUAL_BEARER}` }
    })
    .then(res => res.json())
    .then(styleJson => {
      
      console.log("ğŸ“‹ Style JSON:", styleJson);

      // MapLibre map oluÅŸtur (Ã¼stte, transparent)
      this.maplibreMap = new maplibregl.Map({
        container: this.maplibreDiv,
        style: styleJson,
        center: [32, 39],
        zoom: 15,
        interactive: false, // ArcGIS handle etsin
        attributionControl: false
      });

      this.maplibreMap.on('load', () => {
        console.log("âœ… MapLibre map loaded!");
        this.setState({ message: "âœ… Hybrid map hazÄ±r! (Renkli MVT overlay)" });
        this.syncMaps();
      });

      this.maplibreMap.on('error', (e) => {
        console.error("âŒ MapLibre error:", e);
        this.setState({ message: `âŒ MapLibre error: ${e.error?.message}` });
      });

    })
    .catch(err => {
      console.error("âŒ Style fetch error:", err);
      this.setState({ message: `âŒ Style fetch: ${err.message}` });
    });
  };

  syncMaps = () => {
    // ArcGIS â†’ MapLibre sync
    this.mapView.watch(['center', 'zoom', 'rotation'], () => {
      if (this.syncing || !this.maplibreMap) return;
      
      this.syncing = true;
      
      const center = this.mapView.center;
      this.maplibreMap.jumpTo({
        center: [center.longitude, center.latitude],
        zoom: this.mapView.zoom,
        bearing: -this.mapView.rotation
      });
      
      setTimeout(() => { this.syncing = false; }, 50);
    });
  };

  render() {
    const { message, currentZoom } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        {/* ArcGIS Map (alttta) */}
        <div 
          ref={el => this.arcgisDiv = el}
          style={{ 
            width: "100%", 
            height: "100%", 
            position: "absolute", 
            top: 0, 
            left: 0 
          }}
        />

        {/* MapLibre Overlay (Ã¼stte) */}
        <div 
          ref={el => this.maplibreDiv = el}
          style={{ 
            width: "100%", 
            height: "100%", 
            position: "absolute", 
            top: 0, 
            left: 0,
            pointerEvents: "none", // TÄ±klamalar ArcGIS'e geÃ§sin
            zIndex: 1
          }}
        />

        {/* Controls */}
        <div style={{
          position: "absolute",
          top: "10px",
          right: "10px",
          background: "rgba(0,0,0,0.9)",
          color: "white",
          padding: "20px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "14px",
          minWidth: "250px"
        }}>
          <div style={{ marginBottom: "15px", textAlign: "center", fontWeight: "bold", color: "#00FFFF" }}>
            ğŸŒ HYBRID MODE
          </div>
          
          <div style={{ 
            background: "rgba(255,255,255,0.1)", 
            padding: "15px", 
            borderRadius: "5px",
            marginBottom: "15px",
            textAlign: "center"
          }}>
            <div style={{ fontSize: "12px", color: "#aaa", marginBottom: "5px" }}>
              Zoom Level
            </div>
            <div style={{ fontSize: "32px", fontWeight: "bold", color: "#FFD700" }}>
              {currentZoom}
            </div>
          </div>

          <div style={{ display: "flex", gap: "10px", marginBottom: "15px" }}>
            <button
              onClick={() => {
                if (this.mapView) {
                  this.mapView.goTo({ zoom: this.mapView.zoom - 0.5 });
                }
              }}
              style={{
                flex: 1,
                padding: "15px",
                fontSize: "20px",
                background: "#f44336",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontWeight: "bold"
              }}
            >
              -
            </button>
            <button
              onClick={() => {
                if (this.mapView) {
                  this.mapView.goTo({ zoom: this.mapView.zoom + 0.5 });
                }
              }}
              style={{
                flex: 1,
                padding: "15px",
                fontSize: "20px",
                background: "#4CAF50",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontWeight: "bold"
              }}
            >
              +
            </button>
          </div>

          <div style={{ fontSize: "10px", color: "#00FFFF", lineHeight: "1.5" }}>
            ğŸ“ Basemap: ArcGIS<br/>
            ğŸ¨ MVT: MapLibre (overlay)<br/>
            ğŸ”„ Synced navigation
          </div>
        </div>

        {/* Status */}
        <div style={{
          position: "absolute",
          top: "10px",
          left: "10px",
          background: "rgba(0,0,0,0.85)",
          color: "white",
          padding: "15px",
          borderRadius: "5px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "12px"
        }}>
          <strong style={{ color: "#00FFFF" }}>ğŸŒ Hybrid Status:</strong>
          <div style={{ marginTop: "10px", color: "#FFD700" }}>{message}</div>
          <div style={{ marginTop: "10px", fontSize: "10px", color: "#888" }}>
            Expected: Colored MVT on dark basemap
          </div>
        </div>
      </div>
    );
  }
}
