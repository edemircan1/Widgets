/** @jsx jsx */
import { React, jsx } from "jimu-core";

const MVT_STYLE_URL = "/styles/all/style.json?coverageLayer=rsrp_dbm";
const MANUAL_BEARER = "token";
const ARCGIS_API_VERSION = "4.32";

interface State {
  message: string;
  currentZoom: number;
  logs: string[];
}

export default class Widget extends React.PureComponent<any, State> {
  private mapDiv: HTMLDivElement;
  private mapView: any;

  constructor(props) {
    super(props);
    this.state = {
      message: "BaÅŸlatÄ±lÄ±yor...",
      currentZoom: 15,
      logs: []
    };
  }

  addLog = (msg: string) => {
    console.log(msg);
    this.setState(prev => ({
      logs: [...prev.logs, `${new Date().toLocaleTimeString()}: ${msg}`].slice(-10)
    }));
  };

  componentDidMount() {
    this.loadArcGISAPI();
  }

  componentWillUnmount() {
    if (this.mapView) {
      this.mapView.destroy();
    }
  }

  loadArcGISAPI = () => {
    this.addLog("ğŸ“¦ ArcGIS API yÃ¼kleniyor...");

    if ((window as any).require) {
      this.addLog("âœ… ArcGIS API zaten yÃ¼klÃ¼");
      this.createMap();
      return;
    }

    const cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href = `https://js.arcgis.com/${ARCGIS_API_VERSION}/esri/themes/dark/main.css`;
    document.head.appendChild(cssLink);

    const script = document.createElement("script");
    script.src = `https://js.arcgis.com/${ARCGIS_API_VERSION}/`;
    script.onload = () => {
      this.addLog("âœ… ArcGIS API yÃ¼klendi");
      this.createMap();
    };
    script.onerror = () => {
      this.addLog("âŒ ArcGIS API yÃ¼klenemedi");
    };
    document.head.appendChild(script);
  };

  createMap = () => {
    this.addLog("ğŸ—ºï¸ Map oluÅŸturuluyor...");

    if (!this.mapDiv) {
      setTimeout(() => this.createMap(), 50);
      return;
    }

    (window as any).require([
      'esri/Map',
      'esri/views/MapView',
      'esri/layers/VectorTileLayer',
      'esri/request'
    ], (Map, MapView, VectorTileLayer, esriRequest) => {
      
      this.addLog("âœ… ArcGIS modules loaded");

      const map = new Map({
        basemap: 'dark-gray-vector'
      });

      this.mapView = new MapView({
        container: this.mapDiv,
        map: map,
        center: [32, 39],
        zoom: 15
      });

      this.mapView.when(() => {
        this.addLog("âœ… MapView ready");
      });

      this.mapView.watch('zoom', (newZoom) => {
        this.setState({ currentZoom: Math.round(newZoom * 10) / 10 });
      });

      // Network monitoring
      const originalFetch = window.fetch;
      let tileCount = 0;
      
      window.fetch = (url, options = {}) => {
        const urlStr = url.toString();
        
        // Style JSON request
        if (urlStr.includes('/styles/')) {
          this.addLog(`ğŸ” Fetching style JSON...`);
        }
        
        // Tile requests
        if (urlStr.includes('.pbf')) {
          tileCount++;
          const match = urlStr.match(/\/(\d+)\/(\d+)\/(\d+)\.pbf/);
          if (match) {
            this.addLog(`ğŸ“¦ Tile #${tileCount}: ${match[1]}/${match[2]}/${match[3]}`);
          }
        }
        
        // Add auth header
        if (urlStr.includes('abc.com') || urlStr.includes('/styles/')) {
          return originalFetch(url, {
            ...options,
            headers: {
              ...(options['headers'] || {}),
              'Authorization': `Bearer ${MANUAL_BEARER}`
            }
          });
        }
        
        return originalFetch(url, options);
      };

      // Fetch style JSON
      this.addLog("ğŸ“¥ Requesting style JSON...");
      
      esriRequest(MVT_STYLE_URL, {
        headers: { 'Authorization': `Bearer ${MANUAL_BEARER}` },
        responseType: 'json'
      }).then(response => {
        this.addLog("âœ… Style JSON received");
        this.addLog(`   Sources: ${Object.keys(response.data.sources).join(', ')}`);
        this.addLog(`   Layers: ${response.data.layers.length} layers`);

        // Basit style - sadece kÄ±rmÄ±zÄ± dolgu
        const testStyle = {
          version: 8,
          sources: response.data.sources,
          layers: [
            {
              id: "test_fill_15z",
              type: "fill",
              source: "coverage_15z",
              "source-layer": "data",
              minzoom: 0,
              maxzoom: 24,
              paint: {
                "fill-color": "#FF0000",
                "fill-opacity": 0.8
              }
            }
          ]
        };

        this.addLog("ğŸ¨ Creating VectorTileLayer...");
        
        const layer = new VectorTileLayer({
          style: testStyle,
          title: "Test MVT"
        });

        layer.when(() => {
          this.addLog("âœ… VectorTileLayer.when() fired");
          this.addLog(`   Loaded: ${layer.loaded}`);
          this.addLog(`   Visible: ${layer.visible}`);
          this.addLog(`   Opacity: ${layer.opacity}`);
        }).catch(err => {
          this.addLog(`âŒ Layer error: ${err.message}`);
        });

        map.add(layer);
        this.addLog("â• Layer added to map");

        // Layer listesini kontrol et
        setTimeout(() => {
          this.addLog(`ğŸ“Š Map layers: ${map.layers.length}`);
          map.layers.forEach((l, i) => {
            this.addLog(`   [${i}] ${l.title || l.type}`);
          });
        }, 2000);

      }).catch(err => {
        this.addLog(`âŒ Style fetch error: ${err.message}`);
      });
    });
  };

  render() {
    const { message, currentZoom, logs } = this.state;

    return (
      <div style={{ width: "100%", height: "100%", position: "relative" }}>
        <div 
          ref={el => this.mapDiv = el}
          style={{ width: "100%", height: "100%", background: "#1a1a1a" }}
        />

        {/* Log Panel */}
        <div style={{
          position: "absolute",
          top: "10px",
          right: "10px",
          background: "rgba(0,0,0,0.95)",
          color: "white",
          padding: "15px",
          borderRadius: "8px",
          zIndex: 9999,
          fontFamily: "monospace",
          fontSize: "11px",
          width: "400px",
          maxHeight: "80vh",
          overflow: "auto"
        }}>
          <div style={{ 
            marginBottom: "15px", 
            textAlign: "center", 
            fontWeight: "bold", 
            color: "#FF6B6B",
            fontSize: "14px",
            borderBottom: "1px solid rgba(255,255,255,0.2)",
            paddingBottom: "10px"
          }}>
            ğŸ” MVT DIAGNOSTIC
          </div>

          <div style={{ marginBottom: "15px" }}>
            <div style={{ fontSize: "10px", color: "#aaa" }}>Current Zoom</div>
            <div style={{ fontSize: "24px", fontWeight: "bold", color: "#FFD700" }}>
              {currentZoom}
            </div>
          </div>

          <div style={{ 
            background: "rgba(255,255,255,0.05)", 
            padding: "10px", 
            borderRadius: "5px",
            marginBottom: "10px",
            maxHeight: "400px",
            overflow: "auto"
          }}>
            <div style={{ fontSize: "10px", color: "#4CAF50", marginBottom: "5px", fontWeight: "bold" }}>
              EVENT LOG:
            </div>
            {logs.map((log, i) => (
              <div key={i} style={{ fontSize: "10px", marginBottom: "3px", color: "#ccc" }}>
                {log}
              </div>
            ))}
          </div>

          <div style={{ fontSize: "9px", color: "#888", textAlign: "center", marginTop: "10px" }}>
            âš ï¸ Beklenen: KÄ±rmÄ±zÄ± MVT poligonlarÄ±<br/>
            ğŸ“Š Tile istekleri console'da da gÃ¶rÃ¼nÃ¼r
          </div>

          <div style={{ display: "flex", gap: "10px", marginTop: "15px" }}>
            <button
              onClick={() => {
                if (this.mapView) {
                  this.mapView.goTo({ zoom: this.mapView.zoom - 1 });
                  this.addLog("ğŸ”½ Zoom out");
                }
              }}
              style={{
                flex: 1,
                padding: "10px",
                background: "#f44336",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontSize: "14px"
              }}
            >
              -
            </button>
            <button
              onClick={() => {
                if (this.mapView) {
                  this.mapView.goTo({ zoom: this.mapView.zoom + 1 });
                  this.addLog("ğŸ”¼ Zoom in");
                }
              }}
              style={{
                flex: 1,
                padding: "10px",
                background: "#4CAF50",
                color: "white",
                border: "none",
                borderRadius: "5px",
                cursor: "pointer",
                fontSize: "14px"
              }}
            >
              +
            </button>
          </div>
        </div>
      </div>
    );
  }
}
