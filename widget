/** @jsx jsx */
import { React, AllWidgetProps, jsx } from 'jimu-core';
import { JimuMapViewComponent, JimuMapView } from 'jimu-arcgis';
import maplibregl from 'maplibre-gl';
import 'maplibre-gl/dist/maplibre-gl.css';

// Import the esri-sources plugin
// import { addEsriFeatureLayer } from 'mapbox-gl-esri-sources';

export default class Widget extends React.PureComponent<AllWidgetProps<any>, any> {
  mapContainer: HTMLDivElement;
  map: maplibregl.Map;

  constructor(props) {
    super(props);
    this.state = {};
  }

  componentDidMount() {
    this.initializeMap();
  }

  initializeMap = () => {
    // Initialize MapLibre map with OpenStreetMap basemap
    this.map = new maplibregl.Map({
      container: this.mapContainer,
      style: {
        version: 8,
        sources: {
          'osm': {
            type: 'raster',
            tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
            tileSize: 256,
            attribution: 'Â© OpenStreetMap contributors'
          }
        },
        layers: [
          {
            id: 'osm',
            type: 'raster',
            source: 'osm',
            minzoom: 0,
            maxzoom: 22
          }
        ]
      },
      center: [-118.2437, 34.0522], // Default to LA
      zoom: 10
    });

    this.map.on('load', () => {
      this.addFeatureServerLayer();
    });
  }

  addFeatureServerLayer = () => {
    // REPLACE THIS URL WITH YOUR FEATURESERVER URL
    const featureServerUrl = 'https://services.arcgis.com/YOUR_ORG/arcgis/rest/services/YOUR_SERVICE/FeatureServer/0';

    // Add source
    this.map.addSource('esri-feature-source', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: []
      }
    });

    // Fetch data from FeatureServer
    fetch(`${featureServerUrl}/query?where=1=1&outFields=*&f=geojson`)
      .then(response => response.json())
      .then(data => {
        const source = this.map.getSource('esri-feature-source') as maplibregl.GeoJSONSource;
        if (source) {
          source.setData(data);
        }
      });

    // Add layer to display the features
    this.map.addLayer({
      id: 'esri-feature-layer',
      type: 'circle',
      source: 'esri-feature-source',
      paint: {
        'circle-radius': 6,
        'circle-color': '#007cbf',
        'circle-stroke-width': 2,
        'circle-stroke-color': '#ffffff'
      }
    });
  }

  componentWillUnmount() {
    if (this.map) {
      this.map.remove();
    }
  }

  render() {
    return (
      <div className="widget-maplibre" style={{ width: '100%', height: '100%' }}>
        <div
          ref={el => this.mapContainer = el}
          style={{ width: '100%', height: '100%' }}
        />
      </div>
    );
  }
}