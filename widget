/** @jsx jsx */
import { React, AllWidgetProps, jsx, css } from 'jimu-core';
import maplibregl from 'maplibre-gl';
import 'maplibre-gl/dist/maplibre-gl.css';

export default class Widget extends React.PureComponent<AllWidgetProps<any>, any> {
  mapContainer: HTMLDivElement;
  map: maplibregl.Map;

  FEATURE_SERVER_URL = 'https://abc.dev.ebc.com/arcgissecure/rest/services/ABC/IQ_aw/FeatureServer/2';

  constructor(props) {
    super(props);
    this.state = {
      status: 'Initializing...',
      error: null,
      count: 0,
      token: null,
      method: null
    };
  }

  componentDidMount() {
    this.initMap();
  }

  getOauthToken = async () => {
    try {
      const response = await fetch("https://abc.dev.ebc.com/web/sharing/oauth2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          f: "json",
          referer: window.location.origin,
          client_id: "clientid",
          client_secret: "clientsecret",
          grant_type: "client_credentials"
        }),
        credentials: "include"
      });

      if (!response.ok) {
        throw new Error(`Response status: ${response.status}`);
      }
      const result = await response.json();
      console.log(result.access_token);
      return result.access_token;

    } catch (error) {
      console.error("Error fetching token:", error);
      return null;
    }
  }

  initMap = () => {
    this.setState({ status: 'Loading basemap...' });

    this.map = new maplibregl.Map({
      container: this.mapContainer,
      style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
      center: [0, 0],
      zoom: 2
    });

    this.map.on('load', () => {
      this.setState({ status: 'Basemap loaded. Pick a method.' });
    });
  }

  // Method 1: Token as URL param (arkadaşının yöntemi)
  tryMethod1 = async () => {
    this.clearMap();
    this.setState({ status: 'Method 1: Getting token...', method: 1, error: null });
    const token = await this.getOauthToken();
    if (!token) {
      this.setState({ status: 'Method 1: Token failed', error: 'Could not get token' });
      return;
    }
    this.setState({ token: token });
    const url = `${this.FEATURE_SERVER_URL}/query?f=geojson&where=1=1&outFields=*&returnGeometry=true&outSR=4326&token=${token}`;
    console.log('Method 1 Fetching:', url);
    this.fetchAndRender(url, {});
  }

  // Method 2: Token as Bearer header
  tryMethod2 = async () => {
    this.clearMap();
    this.setState({ status: 'Method 2: Getting token...', method: 2, error: null });
    const token = await this.getOauthToken();
    if (!token) {
      this.setState({ status: 'Method 2: Token failed', error: 'Could not get token' });
      return;
    }
    this.setState({ token: token });
    const url = `${this.FEATURE_SERVER_URL}/query?f=geojson&where=1=1&outFields=*&returnGeometry=true&outSR=4326`;
    console.log('Method 2 Fetching:', url);
    this.fetchAndRender(url, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
  }

  // Method 3: No token, session cookie only
  tryMethod3 = async () => {
    this.clearMap();
    this.setState({ status: 'Method 3: Using session cookie...', method: 3, error: null, token: null });
    const url = `${this.FEATURE_SERVER_URL}/query?f=geojson&where=1=1&outFields=*&returnGeometry=true&outSR=4326`;
    console.log('Method 3 Fetching:', url);
    this.fetchAndRender(url, {
      credentials: 'include'
    });
  }

  fetchAndRender = async (url: string, fetchOptions: any) => {
    try {
      this.setState({ status: `${this.state.status} → Fetching features...` });

      const res = await fetch(url, fetchOptions);

      const contentType = res.headers.get('content-type');
      console.log('Response content-type:', contentType);

      const text = await res.text();
      console.log('Raw response (first 500 chars):', text.substring(0, 500));

      if (text.startsWith('<')) {
        this.setState({
          status: `Method ${this.state.method}: Got HTML, not JSON`,
          error: `Server returned HTML instead of JSON. Likely a redirect or auth page.`
        });
        return;
      }

      const json = JSON.parse(text);
      console.log('Response:', json);

      if (json.error) {
        this.setState({
          status: `Method ${this.state.method}: ArcGIS Error`,
          error: `${json.error.message || JSON.stringify(json.error)}`
        });
        return;
      }

      if (!json.features || json.features.length === 0) {
        this.setState({
          status: `Method ${this.state.method}: No features`,
          error: 'Layer returned 0 features.'
        });
        return;
      }

      this.setState({
        status: `Loading ${json.features.length} features...`,
        count: json.features.length
      });

      this.map.addSource('data', {
        type: 'geojson',
        data: json
      });

      const geomType = json.features[0].geometry.type.toLowerCase();

      if (geomType.includes('point')) {
        this.map.addLayer({
          id: 'layer',
          type: 'circle',
          source: 'data',
          paint: {
            'circle-radius': 6,
            'circle-color': '#e74c3c',
            'circle-stroke-width': 2,
            'circle-stroke-color': '#fff'
          }
        });
      } else if (geomType.includes('line')) {
        this.map.addLayer({
          id: 'layer',
          type: 'line',
          source: 'data',
          paint: {
            'line-color': '#3498db',
            'line-width': 3
          }
        });
      } else if (geomType.includes('polygon')) {
        this.map.addLayer({
          id: 'layer',
          type: 'fill',
          source: 'data',
          paint: {
            'fill-color': '#2ecc71',
            'fill-opacity': 0.6
          }
        });
        this.map.addLayer({
          id: 'outline',
          type: 'line',
          source: 'data',
          paint: {
            'line-color': '#27ae60',
            'line-width': 2
          }
        });
      }

      const bounds = new maplibregl.LngLatBounds();

      json.features.forEach(feature => {
        const geom = feature.geometry;
        if (geom.type === 'Point') {
          bounds.extend(geom.coordinates);
        } else if (geom.type === 'LineString') {
          geom.coordinates.forEach(coord => bounds.extend(coord));
        } else if (geom.type === 'Polygon') {
          geom.coordinates[0].forEach(coord => bounds.extend(coord));
        } else if (geom.type === 'MultiPolygon') {
          geom.coordinates.forEach(polygon => {
            polygon[0].forEach(coord => bounds.extend(coord));
          });
        }
      });

      if (!bounds.isEmpty()) {
        this.map.fitBounds(bounds, { padding: 50, maxZoom: 15 });
      }

      this.setState({
        status: `✓ Method ${this.state.method}: Loaded ${json.features.length} features`,
        error: null
      });

    } catch (err) {
      console.error('Error:', err);
      this.setState({
        status: `Method ${this.state.method}: Failed`,
        error: err.message
      });
    }
  }

  clearMap = () => {
    if (this.map.getLayer('layer')) this.map.removeLayer('layer');
    if (this.map.getLayer('outline')) this.map.removeLayer('outline');
    if (this.map.getSource('data')) this.map.removeSource('data');
    this.setState({ count: 0 });
  }

  componentWillUnmount() {
    if (this.map) this.map.remove();
  }

  render() {
    return (
      <div css={css`width: 100%; height: 100%; position: relative;`}>
        <div ref={el => this.mapContainer = el} css={css`width: 100%; height: 100%;`} />

        <div css={css`
          position: absolute;
          top: 10px;
          left: 10px;
          background: white;
          padding: 12px 15px;
          border-radius: 4px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          font-size: 13px;
          z-index: 1;
          min-width: 250px;
        `}>
          <div css={css`margin-bottom: 10px; display: flex; gap: 6px;`}>
            <button onClick={this.tryMethod1} css={css`padding: 5px 10px; cursor: pointer; font-size: 12px;`}>
              1: Token URL
            </button>
            <button onClick={this.tryMethod2} css={css`padding: 5px 10px; cursor: pointer; font-size: 12px;`}>
              2: Bearer Header
            </button>
            <button onClick={this.tryMethod3} css={css`padding: 5px 10px; cursor: pointer; font-size: 12px;`}>
              3: Session Cookie
            </button>
          </div>
          <div><strong>Status:</strong> {this.state.status}</div>
          {this.state.token && (
            <div><strong>Token:</strong> ✓ Acquired</div>
          )}
          {this.state.count > 0 && (
            <div><strong>Features:</strong> {this.state.count}</div>
          )}
          {this.state.error && (
            <div css={css`color: #d32f2f; margin-top: 8px; font-size: 12px;`}>
              <strong>Error:</strong><br/>{this.state.error}
            </div>
          )}
        </div>
      </div>
    );
  }
}
